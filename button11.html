<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>ë³µí•œì•„ë¦„ ê¸°ë¡ê³µì±…</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <style>
    * { box-sizing: border-box; font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif; }
    body { margin: 0; padding: 10px; background: #f5f5f5; }
    .app {
      max-width: 980px; margin: 0 auto; background: #ffffff; border-radius: 12px;
      padding: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    }
    h1 { margin: 0 0 8px; font-size: 18px; display:flex; align-items:center; justify-content:space-between; gap:8px; flex-wrap:wrap;}
    .badge { font-size:12px; border:1px solid #ddd; border-radius:999px; padding:4px 8px; opacity:.85; }

    .topbar { display:flex; gap:6px; align-items:center; flex-wrap:wrap; margin: 6px 0 10px; }
    .topbar button { padding: 6px 10px; border:1px solid #ddd; border-radius: 10px; background:#fff; cursor:pointer; }
    .topbar button.active { background:#eef7ff; border-color:#b3d4ff; }
    .topbar .spacer { flex: 1; }

    .layout {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
      min-height: 420px;
    }
    @media (max-width: 860px) {
      .layout { grid-template-columns: 1fr; }
    }

    .panel-shell {
      border: 1px solid #e8e8e8;
      border-radius: 12px;
      padding: 10px;
      background: #fff;
      display:flex;
      flex-direction:column;
      min-height: 420px;
    }

    .panel-head { display:flex; align-items:baseline; gap:8px; flex-wrap:wrap; margin-bottom:6px; }
    .panel-title { font-weight: 700; font-size: 14px; }
    .nav-inline { margin-left:auto; display:flex; gap:6px; align-items:center; flex-wrap:wrap; }
    .nav-inline button { padding: 5px 8px; font-size: 12px; border:1px solid #ddd; border-radius: 10px; background:#fff; cursor:pointer; }

    .panel-scroll { flex: 1; min-height: 0; display:flex; flex-direction:column; gap:8px; }

    /* ====== ë””ìì¸(í¬ê¸°) ====== */
    :root {
      --btn-width: 220px;  /* ë””ìì¸ëª¨ë“œì—ì„œ ì¡°ì ˆ */
      --manual-h: 90px;    /* ë””ìì¸ëª¨ë“œì—ì„œ ì¡°ì ˆ */
    }

    .design-panel {
      border: 1px dashed #ddd;
      border-radius: 12px;
      padding: 10px;
      background: #fbfbfb;
      display:none;
      margin-bottom: 8px;
    }
    .design-panel.show { display:block; }
    .design-row { display:flex; align-items:center; gap:10px; flex-wrap:wrap; }
    .design-row label { font-size: 12px; opacity:.85; display:flex; align-items:center; gap:8px; }
    .design-row input[type="range"] { width: 220px; }
    .kv { font-size: 12px; opacity:.7; }

    /* ====== ë²„íŠ¼ëª©ë¡ ====== */
    .buttons-area {
      background:#fafafa;
      border: 1px solid #ddd;
      border-radius: 12px;
      padding: 8px;
      overflow:auto;
      flex: 1;
      min-height: 0;
    }
    .btnrow {
      display:flex;
      gap:6px;
      align-items:stretch;
      margin-bottom:6px;
      flex-wrap:wrap;
    }
    .tree-btn {
      width: var(--btn-width);
      max-width: 100%;
      padding: 10px 10px;
      border:1px solid #ddd;
      border-radius: 14px;
      background:#fff;
      cursor:pointer;
      text-align:center;
      line-height:1.25;
      white-space: pre-wrap;
      word-break: break-word;
    }
    .tree-btn:hover { background:#f6f6f6; }
    .tree-mini {
      padding: 8px 10px;
      border:1px solid #ddd;
      border-radius: 12px;
      background:#fff;
      cursor:pointer;
      font-size:12px;
    }
    .add-current {
      width: 100%;
      padding: 10px;
      border: 1px dashed #ccc;
      border-radius: 12px;
      background: #fff;
      cursor: pointer;
      font-size: 12px;
    }

    /* ====== í´ë¦­ ê¸°ë¡ ====== */
    .log-header { display:flex; align-items:baseline; gap:6px; margin-bottom: 6px; flex-wrap:wrap; }
    .log-count { font-size: 12px; opacity: 0.7; }
    .log-actions { margin-left:auto; display:flex; gap:4px; flex-wrap:wrap; }
    .log-actions button { font-size:11px; padding:4px 6px; border:1px solid #ddd; border-radius: 10px; background:#fff; cursor:pointer; }

    .manual-box {
      border: 1px solid #ddd;
      border-radius: 12px;
      padding: 8px;
      background: #fbfbfb;
    }
    .manual-box .hint {
      font-size: 12px; opacity:.75; margin-bottom: 6px; line-height: 1.35;
    }
    #manualLogInput {
      width: 100%;
      min-height: 48px;
      height: var(--manual-h);
      resize: vertical;
      border: 1px solid #ddd;
      border-radius: 12px;
      padding: 10px;
      font-size: 13px;
      outline: none;
      background:#fff;
      white-space: pre-wrap;
    }

    .log-box {
      background: #fafafa; border-radius: 12px; border: 1px solid #ddd; padding: 8px;
      overflow-y: auto;
      flex: 1;
      min-height: 0;
    }
    #logList { list-style:none; padding:0; margin:0; font-size: 12px; }
    #logList li {
      padding: 4px 2px; border-bottom: 1px solid #eee; word-break: break-word;
      display:flex; align-items:flex-start; gap: 6px;
    }
    #logList li:last-child { border-bottom:none; }
    .log-checkbox { margin-top: 2px; flex-shrink:0; }
    .log-text { flex:1; white-space: pre-wrap; }

    /* ====== í•˜ë‹¨ ====== */
    .help-box {
      border: 1px dashed #ddd; border-radius: 12px; padding: 10px; background: #fbfbfb;
      margin-top: 10px;
    }
    .empty-text { font-size: 12px; opacity: 0.75; line-height: 1.45; white-space: pre-wrap; }
    .help-edit-btn { margin-top: 6px; width: 100%; font-size: 12px; padding: 6px 10px; border:1px solid #ddd; border-radius: 10px; background:#fff; cursor:pointer; }

    .moved-area {
      margin-top: 10px;
      border: 1px solid #eee;
      border-radius: 12px;
      padding: 10px;
      background: #fafafa;
    }
    .auth-bar { display:flex; gap:6px; align-items:center; flex-wrap:wrap; }
    .auth-bar button { padding: 6px 10px; border:1px solid #ddd; border-radius: 10px; background:#fff; cursor:pointer; }
    .auth-status { font-size: 12px; opacity: .75; }
    .note { margin-top: 6px; font-size: 12px; opacity:.75; line-height:1.35; }

    /* ====== ëª¨ë‹¬ ====== */
    .modal-backdrop {
      position: fixed; inset: 0; background: rgba(0,0,0,0.35);
      display: none; align-items: center; justify-content: center; padding: 16px;
      z-index: 9999;
    }
    .modal-backdrop.show { display:flex; }
    .modal {
      width: min(720px, 100%);
      background: #fff; border-radius: 12px; border: 1px solid #ddd;
      box-shadow: 0 10px 30px rgba(0,0,0,0.18);
      padding: 12px;
    }
    .modal h2 { font-size: 14px; margin: 0 0 8px; }
    .modal textarea {
      width: 100%; min-height: 180px; resize: vertical;
      border: 1px solid #ddd; border-radius: 10px; padding: 10px; font-size: 13px;
      outline: none;
    }
    .modal-actions { display:flex; gap:6px; justify-content:flex-end; margin-top: 10px; flex-wrap:wrap; }
    .btn-primary { background: #eef7ff; border-color: #b3d4ff; }
    .modal-actions button { padding: 6px 10px; border:1px solid #ddd; border-radius: 10px; background:#fff; cursor:pointer; }

    /* ====== í†µê³„ ëª¨ë‹¬ ====== */
    .stat-grid { display:grid; grid-template-columns: 1fr 1fr; gap: 8px; }
    .stat-card { border:1px solid #eee; border-radius: 12px; padding: 10px; background:#fafafa; }
    .stat-k { font-size: 12px; opacity:.75; }
    .stat-v { font-size: 18px; font-weight: 800; margin-top: 4px; }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }
    @media (max-width: 520px) { .stat-grid { grid-template-columns: 1fr; } }
  </style>
</head>

<body>
  <div class="app">
    <h1>
      ë³µí•œì•„ë¦„ ê¸°ë¡ê³µì±…
      <span class="badge" id="syncBadge">ë¡œì»¬ ëª¨ë“œ</span>
    </h1>

    <div class="topbar">
      <button id="btnDesignMode">ë””ìì¸ëª¨ë“œ</button>
      <button id="btnStatsMode">í†µê³„ëª¨ë“œ</button>
      <span class="spacer"></span>
      <span class="badge" id="designHint" style="display:none;">ë””ìì¸ëª¨ë“œ ON</span>
    </div>

    <div class="layout">
      <!-- ì¢Œì¸¡: ë²„íŠ¼ ëª©ë¡ -->
      <div class="left panel-shell">
        <div class="panel-head">
          <div class="panel-title">ë²„íŠ¼ ëª©ë¡</div>
          <div class="nav-inline">
            <button id="btnUp">â—€ ìƒìœ„ë¡œ</button>
            <button id="btnRoot">â¬† ìµœìƒìœ„ë¡œ</button>
            <small id="breadcrumb" style="opacity:.7;">ìœ„ì¹˜: ROOT</small>
          </div>
        </div>

        <!-- ë””ìì¸ëª¨ë“œ íŒ¨ë„ -->
        <div class="design-panel" id="designPanel">
          <div class="design-row">
            <label>
              ë²„íŠ¼ í¬ê¸°(ê°€ë¡œ)
              <input id="rangeBtnWidth" type="range" min="120" max="520" step="10" />
              <span class="kv"><span id="valBtnWidth">220</span>px</span>
            </label>

            <label>
              ì§ì ‘ ì…ë ¥ ì¹¸ ê¸¸ì´(ë†’ì´)
              <input id="rangeManualH" type="range" min="48" max="360" step="12" />
              <span class="kv"><span id="valManualH">90</span>px</span>
            </label>
          </div>
          <div class="kv" style="margin-top:6px;">â€» ë””ìì¸ëª¨ë“œì—ì„œë§Œ ì¡°ì ˆ ê°€ëŠ¥. (ë²„íŠ¼/ì§ì ‘ì…ë ¥ì¹¸ ëª¨ë‘ ë°˜ì˜)</div>
        </div>

        <div class="panel-scroll">
          <div class="buttons-area" id="buttonContainer"></div>
          <button class="add-current" id="btnAddHere">+ ì´ ìœ„ì¹˜ì— ìƒˆ ë²„íŠ¼ ì¶”ê°€</button>
        </div>
      </div>

      <!-- ìš°ì¸¡: í´ë¦­ ê¸°ë¡ -->
      <div class="right panel-shell">
        <div class="log-header">
          <div class="panel-title">í´ë¦­ ê¸°ë¡</div>
          <div class="log-count">(ì´ <span id="logCount">0</span>ê°œ)</div>
          <div class="log-actions">
            <button id="btnSelectAllLog">ì „ì²´ ì„ íƒ</button>
            <button id="btnDeleteAllLog">ì „ì²´ ì‚­ì œ</button>
            <button id="btnCopyAllLog">ì „ì²´ ë³µì‚¬</button>
            <button id="btnCopySelectedLog">ì„ íƒ ë³µì‚¬</button>
            <button id="btnEditLog">ì„ íƒ ìˆ˜ì •</button>
            <button id="btnDeleteLog">ì„ íƒ ì‚­ì œ</button>
          </div>
        </div>

        <!-- âœ… ì§ì ‘ ì…ë ¥ -->
        <div class="manual-box">
          <div class="hint">ì—¬ê¸°ì— ì…ë ¥ í›„ <b>Enter</b> (ì˜¤ë¥¸ìª½ í´ë¦­ ê¸°ë¡ì— ì €ì¥) / <b>Shift+Enter</b> ì¤„ë°”ê¿ˆ</div>
          <textarea id="manualLogInput" placeholder="ì˜ˆ) ì˜¤ëŠ˜ ë¯¼ë²• 30ë¶„ / ì •ë¦¬í•  ê²ƒ 2ê°€ì§€&#10;Shift+Enterë¡œ ì¤„ë°”ê¿ˆ ê°€ëŠ¥"></textarea>
        </div>

        <div class="panel-scroll">
          <div class="log-box">
            <ul id="logList"></ul>
          </div>
        </div>
      </div>
    </div>

    <!-- í•˜ë‹¨: ì•ˆë‚´ë¬¸ -->
    <div class="help-box">
      <div class="empty-text" id="helpText"></div>
      <button class="help-edit-btn" id="btnEditHelp">âœï¸ ì•ˆë‚´ë¬¸ ìˆ˜ì •</button>
    </div>

    <!-- í•˜ë‹¨: ë¡œê·¸ì¸ ì˜ì—­ -->
    <div class="moved-area">
      <div class="auth-bar">
        <button id="btnLogin">Google ë¡œê·¸ì¸</button>
        <button id="btnLogout" disabled>ë¡œê·¸ì•„ì›ƒ</button>
        <span class="auth-status" id="authStatus">ë¡œê·¸ì¸ ì•ˆ ë¨</span>
      </div>
      <div class="note">â€» ë¡œê·¸ì¸í•˜ë©´ <b>í•­ìƒ í´ë¼ìš°ë“œ ë°ì´í„°ê°€ ìš°ì„ </b> ì ìš©ë©ë‹ˆë‹¤.</div>
    </div>
  </div>

  <!-- ì•ˆë‚´ë¬¸ í¸ì§‘ ëª¨ë‹¬ -->
  <div class="modal-backdrop" id="helpModalBackdrop">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="helpModalTitle">
      <h2 id="helpModalTitle">ì•ˆë‚´ë¬¸ ìˆ˜ì •</h2>
      <textarea id="helpEditor"></textarea>
      <div class="modal-actions">
        <button id="btnHelpCancel">ì·¨ì†Œ</button>
        <button class="btn-primary" id="btnHelpSave">ì €ì¥</button>
      </div>
    </div>
  </div>

  <!-- í†µê³„ ëª¨ë‹¬ -->
  <div class="modal-backdrop" id="statsBackdrop">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="statsTitle">
      <h2 id="statsTitle">í†µê³„</h2>
      <div class="stat-grid">
        <div class="stat-card">
          <div class="stat-k">í´ë¦­ ê¸°ë¡ ê°œìˆ˜</div>
          <div class="stat-v mono" id="statLogCount">0</div>
        </div>
        <div class="stat-card">
          <div class="stat-k">í´ë¦­ ê¸°ë¡ ê¸€ììˆ˜(ë¼ë²¨ë§Œ)</div>
          <div class="stat-v mono" id="statLogChars">0</div>
        </div>
      </div>
      <div class="modal-actions" style="margin-top:12px;">
        <button id="btnStatsClose">ë‹«ê¸°</button>
      </div>
      <div class="note" style="margin-top:6px;">â€» ê¸€ììˆ˜ëŠ” â€œì§ì ‘ ì…ë ¥/ë²„íŠ¼ ê¸°ë¡ì˜ ë‚´ìš©(label)â€ë§Œ í•©ì‚°í•©ë‹ˆë‹¤. (ì‹œê°„/ì¢Œí‘œ ì œì™¸)</div>
    </div>
  </div>

  <!-- Firebase (í•„ìš” ì‹œ ë²„ì „/êµ¬ì„±ì€ ë„¤ í”„ë¡œì íŠ¸ì™€ ë™ì¼í•˜ê²Œ ìœ ì§€) -->
  <!-- âœ… ë„¤ê°€ ì“°ë˜ ì„¤ì • ê·¸ëŒ€ë¡œ ë¶™ì—¬ë„£ì–´ì•¼ í•¨ -->
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>

  <script>
    /***********************
     * âœ… Firebase ì„¤ì • ë„£ê¸°
     ***********************/
    const firebaseConfig = {
      // apiKey: "...",
      // authDomain: "...",
      // projectId: "...",
      // ...
    };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();
    const provider = new firebase.auth.GoogleAuthProvider();

    /***********************
     * âœ… ì €ì¥í‚¤ (ê¸°ì¡´ ë°ì´í„° ìœ ì§€)
     ***********************/
    const TREE_STORAGE_KEY = "bokhanareum_tree_v1";
    const LOG_STORAGE_KEY  = "bokhanareum_logs_v1";
    const HELP_STORAGE_KEY = "bokhanareum_help_v1";
    const UI_STORAGE_KEY   = "bokhanareum_ui_v1"; // âœ… ìƒˆë¡œ ì¶”ê°€(í˜¸í™˜ ì•ˆì „)

    let currentUser = null;
    let unsubscribeDoc = null;
    let saveTimer = null;
    let isApplyingRemote = false;

    let tree = { id: "root", label: "ROOT", children: [] };
    let logs = [];
    let helpText = "";
    let ui = {
      designMode: false,
      btnWidthPx: 220,
      manualHPx: 90
    };

    const DEFAULT_HELP_TEXT =
`ğŸ’¡ í•˜ìœ„ ë²„íŠ¼ì´ ì—†ëŠ” ë²„íŠ¼ì„ ëˆ„ë¥´ë©´ ì˜¤ë¥¸ìª½ì— ê¸°ë¡ë©ë‹ˆë‹¤.
ğŸ’¡ ì§ì ‘ ì…ë ¥ ì¹¸ì—ì„œ Enterë¡œ ê¸°ë¡ ì €ì¥, Shift+Enterë¡œ ì¤„ë°”ê¿ˆì´ ê°€ëŠ¥í•©ë‹ˆë‹¤.
ğŸ’¾ 1000ê°œë§ˆë‹¤ ë°±ì—…ì„ ê¶Œì¥í•©ë‹ˆë‹¤.`;

    function nowStr() { return new Date().toLocaleString(); }
    function genId() { return "id_" + Date.now().toString(36) + "_" + Math.random().toString(36).slice(2,10); }
    function userDocRef(uid) { return db.collection("users").doc(uid); }

    function safeJSONParse(s, fallback) { try { return JSON.parse(s); } catch { return fallback; } }

    /***********************
     * âœ… UI ì ìš©
     ***********************/
    function applyUIToCSS() {
      document.documentElement.style.setProperty("--btn-width", Math.max(120, ui.btnWidthPx) + "px");
      document.documentElement.style.setProperty("--manual-h", Math.max(48, ui.manualHPx) + "px");

      document.getElementById("valBtnWidth").textContent = String(ui.btnWidthPx);
      document.getElementById("valManualH").textContent = String(ui.manualHPx);

      document.getElementById("rangeBtnWidth").value = String(ui.btnWidthPx);
      document.getElementById("rangeManualH").value = String(ui.manualHPx);

      document.getElementById("btnDesignMode").classList.toggle("active", !!ui.designMode);
      document.getElementById("designPanel").classList.toggle("show", !!ui.designMode);
      document.getElementById("designHint").style.display = ui.designMode ? "inline-block" : "none";
    }

    function loadUILocal() {
      const saved = localStorage.getItem(UI_STORAGE_KEY);
      if (saved) {
        const parsed = safeJSONParse(saved, null);
        if (parsed && typeof parsed === "object") {
          ui = { ...ui, ...parsed };
        }
      }
      applyUIToCSS();
    }
    function saveUILocal() {
      try { localStorage.setItem(UI_STORAGE_KEY, JSON.stringify(ui)); } catch {}
    }
    function saveUI() { saveUILocal(); scheduleCloudSave(); }

    /***********************
     * âœ… ë¡œê·¸ ë Œë”/ì¡°ì‘
     ***********************/
    function updateLogCount() {
      document.getElementById("logCount").textContent = String(logs.length);
    }
    function createLogLi(log, index) {
      const li = document.createElement("li");
      li.dataset.index = index;

      const checkbox = document.createElement("input");
      checkbox.type = "checkbox";
      checkbox.className = "log-checkbox";

      const textSpan = document.createElement("span");
      textSpan.className = "log-text";
      // labelì€ ì¤„ë°”ê¿ˆ ë³´ì¡´
      textSpan.textContent = `${log.time} - [${log.coord}] ${log.label}`;

      li.appendChild(checkbox);
      li.appendChild(textSpan);
      return li;
    }
    function renderLogs() {
      const logList = document.getElementById("logList");
      logList.innerHTML = "";
      logs.forEach((log, idx) => logList.appendChild(createLogLi(log, idx)));
      updateLogCount();
    }
    function appendLog(label, coord) {
      const clean = String(label ?? "").trimEnd();
      if (!clean.trim()) return;
      logs.unshift({ time: nowStr(), label: clean, coord: coord || "-" });
      saveLogs();
      renderLogs();
      showBackupWarningIfNeeded();
    }

    function getSelectedLogItems() {
      const items = Array.from(document.querySelectorAll("#logList li"));
      return items.filter(li => (li.querySelector(".log-checkbox") || {}).checked);
    }
    function selectAllLogs() {
      const items = Array.from(document.querySelectorAll("#logList li .log-checkbox"));
      items.forEach(cb => cb.checked = true);
    }
    function deleteSelectedLogs() {
      const selected = getSelectedLogItems();
      if (selected.length === 0) return alert("ì‚­ì œí•  ê¸°ë¡ì„ ì„ íƒí•˜ì„¸ìš”.");
      if (!confirm(selected.length + "ê°œì˜ ê¸°ë¡ì„ ì‚­ì œí• ê¹Œìš”?")) return;

      const indexes = selected
        .map(li => Number(li.dataset.index))
        .filter(n => !Number.isNaN(n))
        .sort((a,b) => b-a);

      indexes.forEach(idx => { if (idx >= 0 && idx < logs.length) logs.splice(idx, 1); });
      saveLogs();
      renderLogs();
    }
    function editSelectedLog() {
      const selected = getSelectedLogItems();
      if (selected.length === 0) return alert("ìˆ˜ì •í•  ê¸°ë¡ì„ ì„ íƒí•˜ì„¸ìš”.");
      if (selected.length > 1) return alert("í•œ ë²ˆì— í•˜ë‚˜ì˜ ê¸°ë¡ë§Œ ìˆ˜ì •í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.");

      const idx = Number(selected[0].dataset.index);
      if (Number.isNaN(idx) || idx < 0 || idx >= logs.length) return alert("ë¡œê·¸ ì¸ë±ìŠ¤ ì˜¤ë¥˜ì…ë‹ˆë‹¤.");

      const old = logs[idx];
      const newLabel = prompt("ìƒˆ ë‚´ìš©(ë¼ë²¨)ì„ ì…ë ¥í•˜ì„¸ìš”:", old.label);
      if (!newLabel || newLabel.trim() === "") return;

      logs[idx].label = newLabel.trimEnd();
      saveLogs();
      renderLogs();
    }
    function deleteAllLogs() {
      if (logs.length === 0) return alert("ì‚­ì œí•  ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.");
      if (!confirm("ëª¨ë“  ê¸°ë¡ì„ ì‚­ì œí• ê¹Œìš”?")) return;
      logs = [];
      saveLogs();
      renderLogs();
    }
    function copyAllLogs() {
      if (logs.length === 0) return alert("ë³µì‚¬í•  ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.");
      const text = logs.map(l => `${l.time} - [${l.coord}] ${l.label}`).join("\n");
      navigator.clipboard.writeText(text).then(() => alert("ì „ì²´ ê¸°ë¡ì„ ë³µì‚¬í–ˆì–´ìš”."));
    }
    function copySelectedLogs() {
      const selected = getSelectedLogItems();
      if (selected.length === 0) return alert("ë³µì‚¬í•  ê¸°ë¡ì„ ì„ íƒí•˜ì„¸ìš”.");
      const indexes = selected.map(li => Number(li.dataset.index)).filter(n => !Number.isNaN(n));
      const text = indexes.map(i => `${logs[i].time} - [${logs[i].coord}] ${logs[i].label}`).join("\n");
      navigator.clipboard.writeText(text).then(() => alert("ì„ íƒí•œ ê¸°ë¡ì„ ë³µì‚¬í–ˆì–´ìš”."));
    }

    /***********************
     * âœ… í†µê³„
     ***********************/
    function openStats() {
      const count = logs.length;
      const chars = logs.reduce((acc, l) => acc + (String(l.label || "").length), 0);
      document.getElementById("statLogCount").textContent = String(count);
      document.getElementById("statLogChars").textContent = String(chars);
      document.getElementById("statsBackdrop").classList.add("show");
    }
    function closeStats() {
      document.getElementById("statsBackdrop").classList.remove("show");
    }

    /***********************
     * âœ… íŠ¸ë¦¬/ë²„íŠ¼ ë Œë”
     ***********************/
    let currentParentId = "root";

    function findNodeById(node, id) {
      if (!node) return null;
      if (node.id === id) return node;
      const children = node.children || [];
      for (let i = 0; i < children.length; i++) {
        const found = findNodeById(children[i], id);
        if (found) return found;
      }
      return null;
    }
    function findParentId(root, targetId, parentId) {
      if (root.id === targetId) return parentId;
      const children = root.children || [];
      for (let i = 0; i < children.length; i++) {
        const found = findParentId(children[i], targetId, root.id);
        if (found !== null && found !== undefined) return found;
      }
      return null;
    }
    function getCurrentParentNode() {
      const node = findNodeById(tree, currentParentId);
      if (!node) currentParentId = "root";
      return node || tree;
    }

    function renderBreadcrumb() {
      const bc = document.getElementById("breadcrumb");
      bc.textContent = "ìœ„ì¹˜: " + (currentParentId === "root" ? "ROOT" : currentParentId);
    }

    function renderButtons() {
      const parentNode = getCurrentParentNode();
      const container = document.getElementById("buttonContainer");
      container.innerHTML = "";

      const children = parentNode.children || [];
      if (children.length === 0) {
        const empty = document.createElement("div");
        empty.style.opacity = ".7";
        empty.style.fontSize = "12px";
        empty.textContent = "ì´ ìœ„ì¹˜ì— ë²„íŠ¼ì´ ì—†ìŠµë‹ˆë‹¤. ì•„ë˜ì—ì„œ ìƒˆ ë²„íŠ¼ì„ ì¶”ê°€í•˜ì„¸ìš”.";
        container.appendChild(empty);
        return;
      }

      children.forEach((child) => {
        const row = document.createElement("div");
        row.className = "btnrow";

        const btn = document.createElement("button");
        btn.className = "tree-btn";
        btn.textContent = child.label;

        btn.addEventListener("click", () => {
          if (child.children && child.children.length > 0) {
            currentParentId = child.id;
            render();
          } else {
            // âœ… í•˜ìœ„ ë²„íŠ¼ì´ ì—†ìœ¼ë©´ í´ë¦­ ê¸°ë¡ì— ì €ì¥
            appendLog(child.label, "ë²„íŠ¼");
          }
        });

        const btnRename = document.createElement("button");
        btnRename.className = "tree-mini";
        btnRename.textContent = "ì´ë¦„";
        btnRename.addEventListener("click", () => {
          const name = prompt("ìƒˆ ë²„íŠ¼ ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”:", child.label);
          if (!name || !name.trim()) return;
          child.label = name.trim();
          saveTree();
          render();
        });

        const btnDelete = document.createElement("button");
        btnDelete.className = "tree-mini";
        btnDelete.textContent = "ì‚­ì œ";
        btnDelete.addEventListener("click", () => {
          if (!confirm("ì´ ë²„íŠ¼ì„ ì‚­ì œí• ê¹Œìš”?\n(í•˜ìœ„ ë²„íŠ¼ì´ ìˆìœ¼ë©´ í•¨ê»˜ ì‚­ì œë©ë‹ˆë‹¤)")) return;
          parentNode.children = (parentNode.children || []).filter(c => c.id !== child.id);
          saveTree();
          render();
        });

        row.appendChild(btn);
        row.appendChild(btnRename);
        row.appendChild(btnDelete);
        container.appendChild(row);
      });
    }

    function render() {
      renderBreadcrumb();
      renderButtons();
      renderLogs();
      renderHelp();
      applyUIToCSS();
    }

    /***********************
     * âœ… ì•ˆë‚´ë¬¸
     ***********************/
    function renderHelp() {
      const el = document.getElementById("helpText");
      el.textContent = helpText || "";
    }
    function openHelpModal() {
      document.getElementById("helpEditor").value = helpText || "";
      document.getElementById("helpModalBackdrop").classList.add("show");
    }
    function closeHelpModal() {
      document.getElementById("helpModalBackdrop").classList.remove("show");
    }

    /***********************
     * âœ… ì €ì¥(ë¡œì»¬/í´ë¼ìš°ë“œ)
     ***********************/
    function saveTreeLocal() { try { localStorage.setItem(TREE_STORAGE_KEY, JSON.stringify(tree)); } catch {} }
    function saveLogsLocal() { try { localStorage.setItem(LOG_STORAGE_KEY, JSON.stringify(logs)); } catch {} }
    function saveHelpLocal() { try { localStorage.setItem(HELP_STORAGE_KEY, helpText); } catch {} }

    function loadTreeLocal() {
      const saved = localStorage.getItem(TREE_STORAGE_KEY);
      if (saved) {
        const parsed = safeJSONParse(saved, null);
        if (parsed && parsed.id && Array.isArray(parsed.children)) { tree = parsed; return; }
      }
      tree = {
        id: "root",
        label: "ROOT",
        children: [
          { id: genId(), label: "ì˜ˆì‹œ ë²„íŠ¼ 1", children: [] },
          { id: genId(), label: "ì˜ˆì‹œ ë²„íŠ¼ 2", children: [
            { id: genId(), label: "ì˜ˆì‹œ 2-1", children: [] },
            { id: genId(), label: "ì˜ˆì‹œ 2-2", children: [] }
          ] }
        ]
      };
      saveTreeLocal();
    }

    function loadLogsLocal() {
      const saved = localStorage.getItem(LOG_STORAGE_KEY);
      if (saved) {
        const parsed = safeJSONParse(saved, null);
        if (Array.isArray(parsed)) { logs = parsed; return; }
      }
      logs = [];
      saveLogsLocal();
    }

    function loadHelpLocal() {
      const saved = (localStorage.getItem(HELP_STORAGE_KEY) || "");
      helpText = (saved && saved.trim() !== "") ? saved : DEFAULT_HELP_TEXT;
      saveHelpLocal();
    }

    function scheduleCloudSave() {
      if (!currentUser) return;
      if (isApplyingRemote) return;

      clearTimeout(saveTimer);
      saveTimer = setTimeout(async () => {
        try {
          await userDocRef(currentUser.uid).set({
            tree,
            logs,
            helpText,
            ui, // âœ… ìƒˆë¡œ ì¶”ê°€(í˜¸í™˜ ì•ˆì „)
            updatedAtMs: Date.now(),
            updatedAt: firebase.firestore.FieldValue.serverTimestamp()
          }, { merge: true });
        } catch (e) {
          console.warn("cloud save ì‹¤íŒ¨:", e);
        }
      }, 250);
    }

    function saveTree() { saveTreeLocal(); scheduleCloudSave(); }
    function saveLogs() { saveLogsLocal(); scheduleCloudSave(); }
    function saveHelp() { saveHelpLocal(); scheduleCloudSave(); renderHelp(); }

    async function cloudLoad(uid) {
      const snap = await userDocRef(uid).get();
      if (!snap.exists) return null;
      return snap.data();
    }

    async function cloudFirstInit(uid) {
      const remote = await cloudLoad(uid);
      if (remote && (remote.tree || remote.logs || remote.helpText || remote.ui)) {
        applyRemote(remote);
        saveTreeLocal(); saveLogsLocal(); saveHelpLocal(); saveUILocal();
        return;
      }
      await userDocRef(uid).set({
        tree, logs, helpText, ui,
        updatedAtMs: Date.now(),
        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
      }, { merge: true });
    }

    function applyRemote(remote) {
      try {
        isApplyingRemote = true;

        if (remote.tree && remote.tree.id && Array.isArray(remote.tree.children)) tree = remote.tree;
        if (Array.isArray(remote.logs)) logs = remote.logs;
        if (typeof remote.helpText === "string" && remote.helpText.trim() !== "") helpText = remote.helpText;
        if (remote.ui && typeof remote.ui === "object") ui = { ...ui, ...remote.ui };

        // UI CSS ë°˜ì˜
        applyUIToCSS();
        render();
      } finally {
        isApplyingRemote = false;
      }
    }

    function startRealtimeListener(uid) {
      if (unsubscribeDoc) unsubscribeDoc();
      unsubscribeDoc = userDocRef(uid).onSnapshot((snap) => {
        if (!snap.exists) return;
        const remote = snap.data() || {};
        if (isApplyingRemote) return;
        if (!remote.tree && !remote.logs && !remote.helpText && !remote.ui) return;

        applyRemote(remote);
        saveTreeLocal(); saveLogsLocal(); saveHelpLocal(); saveUILocal();
      }, (err) => console.warn("onSnapshot ì˜¤ë¥˜:", err));
    }

    /***********************
     * âœ… ë°±ì—… ê²½ê³ (ê¸°ì¡´ ëŠë‚Œ ìœ ì§€)
     ***********************/
    function showBackupWarningIfNeeded() {
      if (logs.length > 0 && logs.length % 1000 === 0) {
        alert("í´ë¦­ ê¸°ë¡ì´ " + logs.length + "ê°œê°€ ë˜ì—ˆìŠµë‹ˆë‹¤.\në°±ì—…ì„ ê¶Œì¥í•©ë‹ˆë‹¤!");
      }
    }

    /***********************
     * âœ… ë¡œê·¸ì¸ UI
     ***********************/
    function setAuthUI() {
      const badge = document.getElementById("syncBadge");
      const status = document.getElementById("authStatus");
      const btnLogin = document.getElementById("btnLogin");
      const btnLogout = document.getElementById("btnLogout");

      if (currentUser) {
        const name = currentUser.displayName || currentUser.email || "ì‚¬ìš©ì";
        status.textContent = `ë¡œê·¸ì¸ë¨: ${name}`;
        btnLogin.disabled = true;
        btnLogout.disabled = false;
        badge.textContent = "í´ë¼ìš°ë“œ ë™ê¸°í™”";
      } else {
        status.textContent = "ë¡œê·¸ì¸ ì•ˆ ë¨";
        btnLogin.disabled = false;
        btnLogout.disabled = true;
        badge.textContent = "ë¡œì»¬ ëª¨ë“œ";
      }
    }

    /***********************
     * âœ… ì´ë²¤íŠ¸ ë°”ì¸ë”©
     ***********************/
    document.getElementById("btnUp").addEventListener("click", () => {
      if (currentParentId === "root") return;
      const parentId = findParentId(tree, currentParentId, null);
      currentParentId = parentId || "root";
      render();
    });
    document.getElementById("btnRoot").addEventListener("click", () => {
      currentParentId = "root";
      render();
    });
    document.getElementById("btnAddHere").addEventListener("click", () => {
      const parentNode = getCurrentParentNode();
      const name = prompt("ìƒˆ ë²„íŠ¼ ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”:");
      if (!name || !name.trim()) return;
      if (!parentNode.children) parentNode.children = [];
      parentNode.children.push({ id: genId(), label: name.trim(), children: [] });
      saveTree();
      render();
    });

    // ë¡œê·¸ ë²„íŠ¼ë“¤
    document.getElementById("btnSelectAllLog").addEventListener("click", selectAllLogs);
    document.getElementById("btnDeleteLog").addEventListener("click", deleteSelectedLogs);
    document.getElementById("btnEditLog").addEventListener("click", editSelectedLog);
    document.getElementById("btnCopyAllLog").addEventListener("click", copyAllLogs);
    document.getElementById("btnCopySelectedLog").addEventListener("click", copySelectedLogs);
    document.getElementById("btnDeleteAllLog").addEventListener("click", deleteAllLogs);

    // âœ… ì§ì ‘ ì…ë ¥: Enter ì €ì¥ / Shift+Enter ì¤„ë°”ê¿ˆ
    const manual = document.getElementById("manualLogInput");
    manual.addEventListener("keydown", (e) => {
      if (e.key === "Enter" && !e.shiftKey) {
        e.preventDefault();
        const v = manual.value.replace(/\r\n/g, "\n").replace(/\r/g, "\n").trimEnd();
        if (!v.trim()) return;
        appendLog(v, "ì§ì ‘ì…ë ¥");
        manual.value = "";
      }
    });

    // ë””ìì¸ëª¨ë“œ í† ê¸€
    document.getElementById("btnDesignMode").addEventListener("click", () => {
      ui.designMode = !ui.designMode;
      applyUIToCSS();
      saveUI();
    });

    // ë””ìì¸ ìŠ¬ë¼ì´ë”
    document.getElementById("rangeBtnWidth").addEventListener("input", (e) => {
      ui.btnWidthPx = Number(e.target.value || 220);
      applyUIToCSS();
      saveUI();
    });
    document.getElementById("rangeManualH").addEventListener("input", (e) => {
      ui.manualHPx = Number(e.target.value || 90);
      applyUIToCSS();
      saveUI();
    });

    // í†µê³„ëª¨ë“œ
    document.getElementById("btnStatsMode").addEventListener("click", openStats);
    document.getElementById("btnStatsClose").addEventListener("click", closeStats);
    document.getElementById("statsBackdrop").addEventListener("click", (e) => {
      if (e.target.id === "statsBackdrop") closeStats();
    });

    // ì•ˆë‚´ë¬¸
    document.getElementById("btnEditHelp").addEventListener("click", openHelpModal);
    document.getElementById("btnHelpCancel").addEventListener("click", closeHelpModal);
    document.getElementById("btnHelpSave").addEventListener("click", () => {
      const newText = (document.getElementById("helpEditor").value || "").trim();
      if (!newText) return alert("ì•ˆë‚´ë¬¸ì€ ë¹„ì›Œë‘˜ ìˆ˜ ì—†ì–´ìš”.");
      helpText = newText;
      saveHelp();
      closeHelpModal();
    });
    document.getElementById("helpModalBackdrop").addEventListener("click", (e) => {
      if (e.target.id === "helpModalBackdrop") closeHelpModal();
    });

    // ë¡œê·¸ì¸
    document.getElementById("btnLogin").addEventListener("click", async () => {
      try { await auth.signInWithPopup(provider); }
      catch (e) {
        console.error(e);
        alert("ë¡œê·¸ì¸ ì‹¤íŒ¨: íŒì—… ì°¨ë‹¨ ë˜ëŠ” Firebase ë„ë©”ì¸ ì„¤ì • ë¬¸ì œì¼ ìˆ˜ ìˆì–´ìš”.\n\nF12 ì½˜ì†”ì˜ ì—ëŸ¬ì½”ë“œ(auth/...)ë¥¼ í™•ì¸í•´ ì£¼ì„¸ìš”.");
      }
    });
    document.getElementById("btnLogout").addEventListener("click", async () => {
      try { await auth.signOut(); } catch (e) { console.error(e); }
    });

    auth.onAuthStateChanged(async (user) => {
      currentUser = user || null;
      setAuthUI();

      if (!currentUser) {
        if (unsubscribeDoc) unsubscribeDoc();
        unsubscribeDoc = null;
        return;
      }

      try {
        await cloudFirstInit(currentUser.uid);
        startRealtimeListener(currentUser.uid);
        scheduleCloudSave();
      } catch (e) {
        console.error(e);
        alert("í´ë¼ìš°ë“œ ë™ê¸°í™” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. (F12 ì½˜ì†” í™•ì¸)");
      }
    });

    /***********************
     * âœ… ì´ˆê¸° ë¡œë“œ
     ***********************/
    loadTreeLocal();
    loadLogsLocal();
    loadHelpLocal();
    loadUILocal();
    render();
    setAuthUI();
  </script>
</body>
</html>
