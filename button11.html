<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>ë³µí•œì•„ë¦„ ê¸°ë¡ê³µì±…</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    * { box-sizing: border-box; font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif; }
    body { margin: 0; padding: 10px; background: #f5f5f5; }
    .app {
      max-width: 900px; margin: 0 auto; background: #ffffff; border-radius: 12px;
      padding: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    }
    h1 { margin: 0 0 8px; font-size: 18px; display:flex; align-items:center; justify-content:space-between; gap:8px; flex-wrap:wrap;}
    .badge { font-size:12px; border:1px solid #ddd; border-radius:999px; padding:4px 10px; background:#fafafa; }

    /* âœ… ìƒë‹¨ ë¹ˆì¹¸ ì˜ì—­: ì—¬ê¸° ìƒí™©íŒ ë°°ì¹˜ */
    .top-blank { margin: 6px 0 10px; }

    /* =========================
       âœ… ë ˆíŠ¸ë¡œ ìƒí™©íŒ ìŠ¤íƒ€ì¼
       ========================= */
    .retro-panel {
      width: 100%;
      max-width: 560px;
      border-radius: 10px;
      overflow: hidden;
      border: 1px solid #111;
      background: #111;
      box-shadow: 0 6px 16px rgba(0,0,0,0.12);
    }
    .retro-titlebar {
      background: linear-gradient(#d8d8d8, #bdbdbd);
      border-bottom: 1px solid #666;
      padding: 4px 6px;
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 12px;
      color: #111;
      user-select: none;
    }
    .retro-titlebar .pill {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      background: #e7e7e7;
      border: 1px solid #8c8c8c;
      border-radius: 6px;
      padding: 2px 6px;
      font-weight: 600;
    }
    .retro-titlebar .tog {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      font-weight: 700;
    }
    .retro-titlebar .tog .led {
      width: 10px; height: 10px;
      border-radius: 2px;
      border: 1px solid #6a6a6a;
      background: #43ff6e;
      box-shadow: 0 0 6px rgba(67,255,110,0.45);
    }
    .retro-titlebar .spacer { flex: 1; }
    .retro-titlebar .winbtns { display:flex; gap:4px; }
    .retro-titlebar .winbtn {
      width: 16px; height: 16px;
      border-radius: 2px;
      border: 1px solid #6d6d6d;
      background: #e9e9e9;
      display:flex; align-items:center; justify-content:center;
      font-size: 11px;
      line-height: 1;
    }

    .retro-screen-wrap{ padding: 8px; background: #0b0b0b; }
    .retro-screen {
      border-radius: 8px;
      border: 1px solid #004b2b;
      background:
        radial-gradient(circle at 30% 20%, rgba(0,255,120,0.14), transparent 40%),
        radial-gradient(circle at 70% 60%, rgba(0,255,120,0.10), transparent 45%),
        #001a10;
      padding: 10px 10px 10px;
      color: #49ff95;
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;
      box-shadow: inset 0 0 0 1px rgba(0,255,160,0.10);
    }

    .retro-label {
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 8px;
      font-size: 12px;
      opacity: .95;
      margin-bottom: 8px;
    }
    .retro-label b { letter-spacing: .4px; }

    /* âœ… 3x2 ê·¸ë¦¬ë“œ */
    .retro-table {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 6px;
    }
    .cell {
      border-radius: 8px;
      background: rgba(0,0,0,0.35);
      border: 1px solid rgba(0,255,160,0.18);
      padding: 8px;
      min-height: 48px;
      display:flex;
      align-items:center;
      justify-content:center;
      text-align:center;
    }
    .cell.title {
      font-size: 12px;
      opacity: .95;
      line-height: 1.25;
      word-break: keep-all;
    }
    .cell.value {
      font-size: 22px;
      font-weight: 900;
      letter-spacing: 1px;
      text-shadow: 0 0 8px rgba(73,255,149,0.22);
    }

    /* ========================= */

    .auth-bar { display:flex; gap:6px; align-items:center; flex-wrap:wrap; margin-bottom:8px; }
    .auth-status { font-size:12px; opacity:.85; }
    .note { font-size:12px; opacity:.75; margin:6px 0 0; }

    button { cursor: pointer; border-radius: 8px; border: 1px solid #ddd; background: #fff; padding: 6px 10px; font-size: 13px; }
    button:active { transform: scale(0.97); }
    button:disabled { opacity: .5; cursor: not-allowed; }

    .btn-main {
      flex: 1; text-align: left; padding: 10px; border-radius: 10px;
      border: 1px solid #ccc; background: #fafafa; font-size: 14px; min-height: 40px;
    }
    .btn-row { display: flex; align-items: center; gap: 4px; margin-bottom: 6px; }
    .btn-controls { display: flex; gap: 2px; }
    .btn-controls button { padding: 4px 6px; font-size: 11px; }

    .buttons-area { margin-top: 6px; margin-bottom: 10px; max-height: 55vh; overflow-y: auto; padding-right: 4px; }
    .add-current { margin: 4px 0 10px; width: 100%; background: #eef7ff; border-color: #b3d4ff; }

    .layout { display: flex; flex-direction: column; gap: 10px; }
    @media (min-width: 720px) { .layout { flex-direction: row; } }
    .left, .right { flex: 1; min-width: 0; }
    .panel-title { font-size: 14px; margin-bottom: 4px; font-weight: 600; }

    /* âœ… ë²„íŠ¼ ëª©ë¡ ì œëª© ì˜†ì— ë„¤ë¹„ê²Œì´ì…˜ ë²„íŠ¼ ë°°ì¹˜ */
    .panel-head {
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 8px;
      flex-wrap: wrap;
      margin-bottom: 4px;
    }
    .nav-mini {
      display:flex;
      gap: 6px;
      align-items:center;
    }
    .nav-mini button {
      padding: 6px 10px;
      font-size: 13px;
      border-radius: 10px;
    }
    .breadcrumb-line {
      font-size: 12px;
      opacity: 0.75;
      margin: 2px 0 6px;
    }

    .log-header { display: flex; align-items: baseline; gap: 6px; margin-bottom: 4px; flex-wrap: wrap; }
    .log-count { font-size: 12px; opacity: 0.7; }
    .log-actions { margin-left: auto; display: flex; gap: 4px; flex-wrap: wrap; }

    .log-box { background: #fafafa; border-radius: 10px; border: 1px solid #ddd; padding: 8px; max-height: 60vh; overflow-y: auto; }
    #logList { list-style: none; padding: 0; margin: 0; font-size: 12px; }
    #logList li {
      padding: 4px 2px; border-bottom: 1px solid #eee; word-break: break-all;
      display: flex; align-items: center; gap: 4px;
    }
    #logList li:last-child { border-bottom: none; }
    .log-text { flex: 1; }
    .log-checkbox { flex-shrink: 0; }

    .empty-text { font-size: 12px; opacity: 0.75; line-height: 1.45; white-space: pre-wrap; }
    .help-edit-btn { margin-top: 6px; width: 100%; font-size: 12px; padding: 6px 10px; }
    .help-box {
      border: 1px dashed #ddd; border-radius: 10px; padding: 10px; background: #fbfbfb;
      margin-top: 8px;
    }

    .moved-area {
      margin-top: 10px;
      border: 1px solid #eee;
      border-radius: 10px;
      padding: 10px;
      background: #fafafa;
    }
    .moved-area .note { margin-top: 6px; }

    .modal-backdrop {
      position: fixed; inset: 0; background: rgba(0,0,0,0.35);
      display: none; align-items: center; justify-content: center; padding: 16px;
      z-index: 9999;
    }
    .modal {
      width: min(720px, 100%);
      background: #fff; border-radius: 12px; border: 1px solid #ddd;
      box-shadow: 0 10px 30px rgba(0,0,0,0.18);
      padding: 12px;
    }
    .modal h2 { font-size: 14px; margin: 0 0 8px; }
    .modal textarea {
      width: 100%; min-height: 180px; resize: vertical;
      border: 1px solid #ddd; border-radius: 10px; padding: 10px; font-size: 13px;
      outline: none;
    }
    .modal-actions { display: flex; gap: 6px; justify-content: flex-end; margin-top: 10px; flex-wrap: wrap; }
    .btn-primary { background: #eef7ff; border-color: #b3d4ff; }
  </style>
</head>
<body>
  <div class="app">
    <h1>
      ë³µí•œì•„ë¦„ ê¸°ë¡ê³µì±…
      <span class="badge" id="syncBadge">ë¡œì»¬ ëª¨ë“œ</span>
    </h1>

    <!-- âœ… ìƒë‹¨ ë¹ˆì¹¸: 3x2 ìƒí™©íŒ (ì„¤ëª… í…ìŠ¤íŠ¸ ì œê±°ë¨) -->
    <div class="top-blank">
      <div class="retro-panel" aria-label="ìƒí™©íŒ">
        <div class="retro-titlebar">
          <span class="pill">setup</span>
          <span class="tog"><span class="led"></span>on</span>
          <span class="spacer"></span>
          <div class="winbtns" aria-hidden="true">
            <div class="winbtn">?</div>
            <div class="winbtn">â€“</div>
            <div class="winbtn">Ã—</div>
          </div>
        </div>
        <div class="retro-screen-wrap">
          <div class="retro-screen">
            <div class="retro-label">
              <b>keystrokes</b>
              <span style="opacity:.85;font-size:11px;">(ë¡œê·¸ ì‚­ì œí•´ë„ ìœ ì§€)</span>
            </div>

            <div class="retro-table">
              <div class="cell title">ì ê¸ˆ(ìŠ¤ë§ˆíŠ¸í°)</div>
              <div class="cell title">ì ê¸ˆ(í…Œë¸”ë¦¿)</div>
              <div class="cell title">ë²ˆì•„ì›ƒ(3ë‹¨ê³„)</div>

              <div class="cell value" id="statPhoneLock">0</div>
              <div class="cell value" id="statTabletLock">0</div>
              <div class="cell value" id="statBurnout3">0</div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="layout">
      <div class="left">
        <!-- âœ… ì—¬ê¸°ë¡œ â€œìƒìœ„ë¡œ/ìµœìƒìœ„ë¡œâ€ë§Œ ì´ë™ -->
        <div class="panel-head">
          <div class="panel-title" style="margin:0;">ë²„íŠ¼ ëª©ë¡</div>
          <div class="nav-mini">
            <button id="btnUp">â—€ ìƒìœ„ë¡œ</button>
            <button id="btnRoot">â¬† ìµœìƒìœ„ë¡œ</button>
          </div>
        </div>
        <div class="breadcrumb-line" id="breadcrumb">ìœ„ì¹˜: ROOT</div>

        <div class="buttons-area" id="buttonContainer"></div>
        <button class="add-current" id="btnAddHere">+ ì´ ìœ„ì¹˜ì— ìƒˆ ë²„íŠ¼ ì¶”ê°€</button>

        <div class="help-box">
          <div class="empty-text" id="helpText"></div>
          <button class="help-edit-btn" id="btnEditHelp">âœï¸ ì•ˆë‚´ë¬¸ ìˆ˜ì •</button>
        </div>

        <div class="moved-area">
          <div class="auth-bar">
            <button id="btnLogin">Google ë¡œê·¸ì¸</button>
            <button id="btnLogout" disabled>ë¡œê·¸ì•„ì›ƒ</button>
            <span class="auth-status" id="authStatus">ë¡œê·¸ì¸ ì•ˆ ë¨</span>
          </div>
          <div class="note">â€» ë¡œê·¸ì¸í•˜ë©´ <b>í•­ìƒ í´ë¼ìš°ë“œ ë°ì´í„°ê°€ ìš°ì„ </b> ì ìš©ë©ë‹ˆë‹¤. (ë¡œì»¬ì€ ìë™ìœ¼ë¡œ í´ë¼ìš°ë“œë¡œ ë§ì¶°ì§)</div>
        </div>
      </div>

      <div class="right">
        <div class="log-header">
          <div class="panel-title">í´ë¦­ ê¸°ë¡</div>
          <div class="log-count">(ì´ <span id="logCount">0</span>ê°œ)</div>
          <div class="log-actions">
            <button id="btnDeleteAllLog" style="font-size:11px;padding:4px 6px;">ì „ì²´ ì‚­ì œ</button>
            <button id="btnCopyAllLog" style="font-size:11px;padding:4px 6px;">ì „ì²´ ë³µì‚¬</button>
            <button id="btnCopySelectedLog" style="font-size:11px;padding:4px 6px;">ì„ íƒ ë³µì‚¬</button>
            <button id="btnEditLog" style="font-size:11px;padding:4px 6px;">ì„ íƒ ìˆ˜ì •</button>
            <button id="btnDeleteLog" style="font-size:11px;padding:4px 6px;">ì„ íƒ ì‚­ì œ</button>
          </div>
        </div>
        <div class="log-box">
          <ul id="logList"></ul>
        </div>
      </div>
    </div>
  </div>

  <!-- ì•ˆë‚´ë¬¸ í¸ì§‘ ëª¨ë‹¬ -->
  <div class="modal-backdrop" id="helpModalBackdrop">
    <div class="modal">
      <h2>ì•ˆë‚´ë¬¸ ìˆ˜ì •</h2>
      <textarea id="helpEditor" placeholder="ì—¬ê¸°ì— ì•ˆë‚´ë¬¸ì„ ì…ë ¥í•˜ì„¸ìš”."></textarea>
      <div class="modal-actions">
        <button id="btnHelpCancel">ì·¨ì†Œ</button>
        <button class="btn-primary" id="btnHelpSave">ì €ì¥</button>
      </div>
    </div>
  </div>

  <!-- Firebase (compat) -->
  <script src="https://www.gstatic.com/firebasejs/10.12.5/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.5/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore-compat.js"></script>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyC8kLsUhGLu4eGhTYlKlh-tKCQkKjF0EvU",
      authDomain: "button-tree.firebaseapp.com",
      projectId: "button-tree",
      storageBucket: "button-tree.firebasestorage.app",
      messagingSenderId: "670872655484",
      appId: "1:670872655484:web:a8f5a5201cd845a4075bf9",
      measurementId: "G-9P3ZV8LLQ3"
    };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();
    const provider = new firebase.auth.GoogleAuthProvider();

    const TREE_STORAGE_KEY = "buttonTree_v_local";
    const LOG_STORAGE_KEY  = "buttonLogs_v1";
    const HELP_STORAGE_KEY = "buttonHelpText_v1";
    const STATS_STORAGE_KEY = "buttonStats_v2";

    const BACKUP_WARN_THRESHOLD = 1000;

    let tree = null;
    let currentParentId = "root";
    let logs = [];
    let helpText = "";

    let stats = { phoneLock: 0, tabletLock: 0, burnout3: 0 };

    let currentUser = null;
    let unsubscribeDoc = null;
    let isApplyingRemote = false;
    let saveTimer = null;

    function genId() {
      return "id_" + Date.now().toString(36) + "_" + Math.random().toString(36).slice(2, 8);
    }
    function nowMs() { return Date.now(); }

    function showBackupWarningIfNeeded() {
      if (!Array.isArray(logs)) return;
      if (logs.length < BACKUP_WARN_THRESHOLD) return;
      alert(
        "âš  í´ë¦­ ê¸°ë¡ì´ 1,000ê°œ ì´ìƒì…ë‹ˆë‹¤.\n\n" +
        "ë°ì´í„° ì†ì‹¤ ìœ„í—˜ì´ ìˆìŠµë‹ˆë‹¤.\n" +
        "'ì „ì²´ ë³µì‚¬'ë¡œ ì£¼ê¸°ì ìœ¼ë¡œ ë°±ì—…í•˜ì„¸ìš”."
      );
    }

    function setAuthUI() {
      const status = document.getElementById("authStatus");
      const btnLogin = document.getElementById("btnLogin");
      const btnLogout = document.getElementById("btnLogout");
      const badge = document.getElementById("syncBadge");

      if (currentUser) {
        const name = currentUser.displayName || currentUser.email || "ì‚¬ìš©ì";
        status.textContent = `ë¡œê·¸ì¸ë¨: ${name}`;
        btnLogin.disabled = true;
        btnLogout.disabled = false;
        badge.textContent = "í´ë¼ìš°ë“œ ë™ê¸°í™”";
      } else {
        status.textContent = "ë¡œê·¸ì¸ ì•ˆ ë¨";
        btnLogin.disabled = false;
        btnLogout.disabled = true;
        badge.textContent = "ë¡œì»¬ ëª¨ë“œ";
      }
    }
    function userDocRef(uid) { return db.collection("users").doc(uid); }

    /* âœ… ìƒí™©íŒ */
    function renderStats() {
      const a = document.getElementById("statPhoneLock");
      const b = document.getElementById("statTabletLock");
      const c = document.getElementById("statBurnout3");
      if (a) a.textContent = String(stats.phoneLock ?? 0);
      if (b) b.textContent = String(stats.tabletLock ?? 0);
      if (c) c.textContent = String(stats.burnout3 ?? 0);
    }

    function saveStatsLocal() {
      try { localStorage.setItem(STATS_STORAGE_KEY, JSON.stringify(stats)); }
      catch (e) { console.warn("localStorage í†µê³„ ì €ì¥ ì˜¤ë¥˜:", e); }
    }
    function loadStatsLocal() {
      let saved = null;
      try { saved = localStorage.getItem(STATS_STORAGE_KEY); } catch {}
      if (saved) {
        try {
          const parsed = JSON.parse(saved);
          if (parsed && typeof parsed === "object") {
            stats = {
              phoneLock: Number(parsed.phoneLock || 0),
              tabletLock: Number(parsed.tabletLock || 0),
              burnout3: Number(parsed.burnout3 || 0)
            };
          }
        } catch {}
      }
      renderStats();
    }
    function saveStats() { saveStatsLocal(); scheduleCloudSave(); }

    function bumpStatsIfMatch(label) {
      if (label === "ì ê¸ˆ(ìŠ¤ë§ˆíŠ¸í°)") {
        stats.phoneLock = (stats.phoneLock ?? 0) + 1;
      } else if (label === "ì ê¸ˆ(í…Œë¸”ë¦¿)") {
        stats.tabletLock = (stats.tabletLock ?? 0) + 1;
      } else if (label === "ë²ˆì•„ì›ƒ(3ë‹¨ê³„)") {
        stats.burnout3 = (stats.burnout3 ?? 0) + 1;
      } else {
        return;
      }
      saveStats();
      renderStats();
    }

    /* âœ… ì•ˆë‚´ë¬¸ */
    const DEFAULT_HELP_TEXT =
`ğŸ’¡ í•˜ìœ„ ë²„íŠ¼ì´ ì—†ëŠ” ë²„íŠ¼ì„ ëˆ„ë¥´ë©´ ì˜¤ë¥¸ìª½ì— ê¸°ë¡ë©ë‹ˆë‹¤.
1000ê°œë§ˆë‹¤ ë°±ì—…ì„ í•©ë‹ˆë‹¤. ë°±ì—…ì„ í•œ ë’¤ì—ëŠ” ê°€ì¥ ë°‘ì— ë²„íŠ¼ì— ë°±ì—…í•œ ìë£Œì˜ ê°œìˆ˜ë¥¼ ì ì–´ë†“ìŠµë‹ˆë‹¤.`;

    function saveHelpLocal() {
      try { localStorage.setItem(HELP_STORAGE_KEY, helpText); }
      catch (e) { console.warn("localStorage ì•ˆë‚´ë¬¸ ì €ì¥ ì˜¤ë¥˜:", e); }
    }
    function loadHelpLocal() {
      let saved = "";
      try { saved = localStorage.getItem(HELP_STORAGE_KEY) || ""; } catch {}
      helpText = (saved && saved.trim() !== "") ? saved : DEFAULT_HELP_TEXT;
      renderHelp();
    }
    function renderHelp() {
      const el = document.getElementById("helpText");
      if (!el) return;
      el.textContent = helpText || "";
    }
    function saveHelp() { saveHelpLocal(); scheduleCloudSave(); renderHelp(); }

    /* ë¡œì»¬ ì €ì¥ */
    function saveTreeLocal() {
      try { localStorage.setItem(TREE_STORAGE_KEY, JSON.stringify(tree)); }
      catch (e) { console.warn("localStorage íŠ¸ë¦¬ ì €ì¥ ì˜¤ë¥˜:", e); }
    }
    function saveLogsLocal() {
      try { localStorage.setItem(LOG_STORAGE_KEY, JSON.stringify(logs)); }
      catch (e) { console.warn("localStorage ë¡œê·¸ ì €ì¥ ì˜¤ë¥˜:", e); }
    }

    function loadTreeLocal() {
      let saved = null;
      try { saved = localStorage.getItem(TREE_STORAGE_KEY); } catch {}
      if (saved) {
        try {
          const parsed = JSON.parse(saved);
          if (parsed && parsed.id && Array.isArray(parsed.children)) { tree = parsed; return; }
        } catch {}
      }
      tree = { id: "root", label: "ROOT", children: [] };
      saveTreeLocal();
    }

    function loadLogsLocal() {
      let saved = null;
      try { saved = localStorage.getItem(LOG_STORAGE_KEY); } catch {}
      if (saved) {
        try {
          const parsed = JSON.parse(saved);
          if (Array.isArray(parsed)) { logs = parsed; renderLogs(); return; }
        } catch {}
      }
      logs = [];
      renderLogs();
    }

    /* í´ë¼ìš°ë“œ */
    async function cloudLoad(uid) {
      const snap = await userDocRef(uid).get();
      if (!snap.exists) return null;
      return snap.data();
    }

    function scheduleCloudSave() {
      if (!currentUser) return;
      if (isApplyingRemote) return;

      clearTimeout(saveTimer);
      saveTimer = setTimeout(async () => {
        try {
          await userDocRef(currentUser.uid).set({
            tree,
            logs,
            helpText,
            stats,
            updatedAtMs: nowMs(),
            updatedAt: firebase.firestore.FieldValue.serverTimestamp()
          }, { merge: true });
        } catch (e) {
          console.warn("cloud save ì‹¤íŒ¨:", e);
        }
      }, 300);
    }

    async function cloudFirstInit(uid) {
      const remote = await cloudLoad(uid);

      if (remote && (remote.tree || remote.logs || remote.helpText || remote.stats)) {
        applyRemote(remote);
        saveTreeLocal(); saveLogsLocal(); saveHelpLocal(); saveStatsLocal();
        return;
      }

      await userDocRef(uid).set({
        tree, logs, helpText, stats,
        updatedAtMs: nowMs(),
        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
      }, { merge: true });
    }

    function applyRemote(remote) {
      try {
        isApplyingRemote = true;
        const prevParentId = currentParentId;

        if (remote.tree && remote.tree.id && Array.isArray(remote.tree.children)) {
          tree = remote.tree;
          const stillExists = findNodeById(tree, prevParentId);
          currentParentId = stillExists ? prevParentId : "root";
        }
        if (Array.isArray(remote.logs)) logs = remote.logs;
        if (typeof remote.helpText === "string" && remote.helpText.trim() !== "") helpText = remote.helpText;

        if (remote.stats && typeof remote.stats === "object") {
          stats = {
            phoneLock: Number(remote.stats.phoneLock || 0),
            tabletLock: Number(remote.stats.tabletLock || 0),
            burnout3: Number(remote.stats.burnout3 || 0)
          };
        }

        renderLogs(); render(); renderHelp(); renderStats();
        showBackupWarningIfNeeded();
      } finally {
        isApplyingRemote = false;
      }
    }

    function startRealtimeListener(uid) {
      if (unsubscribeDoc) unsubscribeDoc();
      unsubscribeDoc = userDocRef(uid).onSnapshot((snap) => {
        if (!snap.exists) return;
        const remote = snap.data() || {};
        if (isApplyingRemote) return;
        if (!remote.tree && !remote.logs && !remote.helpText && !remote.stats) return;

        applyRemote(remote);
        saveTreeLocal(); saveLogsLocal(); saveHelpLocal(); saveStatsLocal();
      }, (err) => console.warn("onSnapshot ì˜¤ë¥˜:", err));
    }

    function saveTree() { saveTreeLocal(); scheduleCloudSave(); }
    function saveLogs() { saveLogsLocal(); scheduleCloudSave(); }

    /* íŠ¸ë¦¬ ìœ í‹¸ */
    function findNodeById(node, id) {
      if (!node) return null;
      if (node.id === id) return node;
      const children = node.children || [];
      for (let i = 0; i < children.length; i++) {
        const found = findNodeById(children[i], id);
        if (found) return found;
      }
      return null;
    }
    function findP
