<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>ë²„íŠ¼ íŠ¸ë¦¬ ê¸°ë¡ ì•±</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    * {
      box-sizing: border-box;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
    }
    body {
      margin: 0;
      padding: 10px;
      background: #f5f5f5;
    }
    .app {
      max-width: 900px;
      margin: 0 auto;
      background: #ffffff;
      border-radius: 12px;
      padding: 12px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    }
    h1 {
      margin: 0 0 8px;
      font-size: 18px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
      flex-wrap: wrap;
    }

    .auth-bar {
      display: flex;
      gap: 6px;
      align-items: center;
      flex-wrap: wrap;
      margin-bottom: 8px;
    }
    .auth-status {
      font-size: 12px;
      opacity: 0.8;
      padding-left: 2px;
    }
    .pill {
      font-size: 12px;
      border: 1px solid #ddd;
      border-radius: 999px;
      padding: 4px 8px;
      background: #fafafa;
    }

    .top-bar {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      align-items: center;
      margin-bottom: 8px;
    }
    .top-bar small {
      opacity: 0.8;
    }
    button {
      cursor: pointer;
      border-radius: 8px;
      border: 1px solid #ddd;
      background: #fff;
      padding: 6px 10px;
      font-size: 13px;
    }
    button:active {
      transform: scale(0.97);
    }
    button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    .btn-main {
      flex: 1;
      text-align: left;
      padding: 10px;
      border-radius: 10px;
      border: 1px solid #ccc;
      background: #fafafa;
      font-size: 14px;
      min-height: 40px;
    }
    .btn-row {
      display: flex;
      align-items: center;
      gap: 4px;
      margin-bottom: 6px;
    }
    .btn-controls {
      display: flex;
      gap: 2px;
    }
    .btn-controls button {
      padding: 4px 6px;
      font-size: 11px;
    }
    .buttons-area {
      margin-top: 6px;
      margin-bottom: 10px;
      max-height: 55vh;
      overflow-y: auto;
      padding-right: 4px;
    }
    .add-current {
      margin: 4px 0 10px;
      width: 100%;
      background: #eef7ff;
      border-color: #b3d4ff;
    }
    .layout {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }
    @media (min-width: 720px) {
      .layout {
        flex-direction: row;
      }
    }
    .left, .right {
      flex: 1;
      min-width: 0;
    }
    .panel-title {
      font-size: 14px;
      margin-bottom: 4px;
      font-weight: 600;
    }
    .log-header {
      display: flex;
      align-items: baseline;
      gap: 6px;
      margin-bottom: 4px;
      flex-wrap: wrap;
    }
    .log-count {
      font-size: 12px;
      opacity: 0.7;
    }
    .log-actions {
      margin-left: auto;
      display: flex;
      gap: 4px;
      flex-wrap: wrap;
    }
    .log-box {
      background: #fafafa;
      border-radius: 10px;
      border: 1px solid #ddd;
      padding: 8px;
      max-height: 60vh;
      overflow-y: auto;
    }
    #logList {
      list-style: none;
      padding: 0;
      margin: 0;
      font-size: 12px;
    }
    #logList li {
      padding: 4px 2px;
      border-bottom: 1px solid #eee;
      word-break: break-all;
      display: flex;
      align-items: center;
      gap: 4px;
    }
    #logList li:last-child {
      border-bottom: none;
    }
    .log-text {
      flex: 1;
    }
    .log-checkbox {
      flex-shrink: 0;
    }
    .empty-text {
      font-size: 12px;
      opacity: 0.6;
    }
  </style>
</head>
<body>
  <div class="app">
    <h1>
      ë²„íŠ¼ íŠ¸ë¦¬ ê¸°ë¡ ì•±
      <span class="pill" id="syncMode">ë¡œì»¬ ëª¨ë“œ</span>
    </h1>

    <div class="auth-bar">
      <button id="btnLogin">Google ë¡œê·¸ì¸</button>
      <button id="btnLogout" disabled>ë¡œê·¸ì•„ì›ƒ</button>
      <span class="auth-status" id="authStatus">ë¡œê·¸ì¸ ì•ˆ ë¨</span>
    </div>

    <div class="top-bar">
      <button id="btnUp">â—€ ìƒìœ„ë¡œ</button>
      <button id="btnRoot">â¬† ìµœìƒìœ„ë¡œ</button>
      <small id="breadcrumb">ìœ„ì¹˜: ROOT</small>
    </div>

    <div class="layout">
      <div class="left">
        <div class="panel-title">ë²„íŠ¼ ëª©ë¡</div>
        <div class="buttons-area" id="buttonContainer">
          <!-- ë²„íŠ¼ë“¤ì´ ì—¬ê¸°ì— ë Œë”ë§ë¨ -->
        </div>
        <button class="add-current" id="btnAddHere">+ ì´ ìœ„ì¹˜ì— ìƒˆ ë²„íŠ¼ ì¶”ê°€</button>
        <div class="empty-text">
          ğŸ’¡ í•˜ìœ„ ë²„íŠ¼ì´ ì—†ëŠ” ë²„íŠ¼ì„ ëˆ„ë¥´ë©´ ì˜¤ë¥¸ìª½ì— ê¸°ë¡ë©ë‹ˆë‹¤.<br>
          [A1], [B2] ê°™ì€ í‘œì‹œëŠ” ì—‘ì…€ì˜ ì—´(A,B,...)ê³¼ í–‰(1,2,...)ì„ ì˜ë¯¸í•©ë‹ˆë‹¤.
        </div>
      </div>

      <div class="right">
        <div class="log-header">
          <div class="panel-title">í´ë¦­ ê¸°ë¡</div>
          <div class="log-count">(ì´ <span id="logCount">0</span>ê°œ)</div>
          <div class="log-actions">
            <button id="btnCopyAllLog" style="font-size:11px;padding:4px 6px;">ì „ì²´ ë³µì‚¬</button>
            <button id="btnCopySelectedLog" style="font-size:11px;padding:4px 6px;">ì„ íƒ ë³µì‚¬</button>
            <button id="btnEditLog" style="font-size:11px;padding:4px 6px;">ì„ íƒ ìˆ˜ì •</button>
            <button id="btnDeleteLog" style="font-size:11px;padding:4px 6px;">ì„ íƒ ì‚­ì œ</button>
          </div>
        </div>
        <div class="log-box">
          <ul id="logList"></ul>
        </div>
      </div>
    </div>
  </div>

  <!-- Firebase (compat) -->
  <script src="https://www.gstatic.com/firebasejs/10.12.5/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.5/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore-compat.js"></script>

  <script>
    /***********************
     * 1) Firebase ì„¤ì •
     ***********************/
    const firebaseConfig = {
      apiKey: "AIzaSyC8kLsUhGLu4eGhTYlKlh-tKCQkKjF0EvU",
      authDomain: "button-tree.firebaseapp.com",
      projectId: "button-tree",
      storageBucket: "button-tree.firebasestorage.app",
      messagingSenderId: "670872655484",
      appId: "1:670872655484:web:a8f5a5201cd845a4075bf9",
      measurementId: "G-9P3ZV8LLQ3"
    };

    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    // GitHub Pages ë„ë©”ì¸ì—ì„œ êµ¬ê¸€ ë¡œê·¸ì¸ íŒì—…ì´ ë§‰íˆë©´ redirectë¡œ ë°”ê¿”ë„ ë¨.
    const provider = new firebase.auth.GoogleAuthProvider();

    /***********************
     * 2) ë¡œì»¬ í‚¤
     ***********************/
    const TREE_STORAGE_KEY = "buttonTree_v_local";
    const LOG_STORAGE_KEY  = "buttonLogs_v1";

    // íŠ¸ë¦¬ êµ¬ì¡°: { id, label, children: [] }
    let tree = null;
    let currentParentId = "root";

    // ë¡œê·¸ êµ¬ì¡°: { time, label, coord }
    // logs[0] ì´ í™”ë©´ì—ì„œ ì œì¼ ìœ„ì— í‘œì‹œë˜ëŠ” ìµœì‹  ê¸°ë¡
    let logs = [];

    // ë¡œê·¸ì¸ ìƒíƒœ
    let currentUser = null;
    let cloudReady = false; // ìµœì´ˆ ë™ê¸°í™” ì™„ë£Œ ì—¬ë¶€
    let isApplyingRemote = false; // ì›ê²© ì ìš© ì¤‘ì´ë©´ save íŠ¸ë¦¬ê±° ë°©ì§€

    /***********************
     * 3) ìœ í‹¸
     ***********************/
    function genId() {
      return "id_" + Date.now().toString(36) + "_" +
             Math.random().toString(36).slice(2, 8);
    }

    function setSyncBadge() {
      const badge = document.getElementById("syncMode");
      if (!badge) return;
      badge.textContent = currentUser ? "í´ë¼ìš°ë“œ ë™ê¸°í™”" : "ë¡œì»¬ ëª¨ë“œ";
    }

    function setAuthUI() {
      const status = document.getElementById("authStatus");
      const btnLogin = document.getElementById("btnLogin");
      const btnLogout = document.getElementById("btnLogout");

      if (!status || !btnLogin || !btnLogout) return;

      if (currentUser) {
        const name = currentUser.displayName || currentUser.email || "ì‚¬ìš©ì";
        status.textContent = `ë¡œê·¸ì¸ë¨: ${name}`;
        btnLogin.disabled = true;
        btnLogout.disabled = false;
      } else {
        status.textContent = "ë¡œê·¸ì¸ ì•ˆ ë¨";
        btnLogin.disabled = false;
        btnLogout.disabled = true;
      }
      setSyncBadge();
    }

    function userDocRef(uid) {
      return db.collection("users").doc(uid);
    }

    async function cloudLoad(uid) {
      const ref = userDocRef(uid);
      const snap = await ref.get();
      if (!snap.exists) return null;
      return snap.data();
    }

    async function cloudSave(uid) {
      if (!uid) return;
      if (!cloudReady) return;
      if (isApplyingRemote) return;

      const ref = userDocRef(uid);
      const payload = {
        tree: tree,
        logs: logs,
        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
      };
      try {
        await ref.set(payload, { merge: true });
      } catch (e) {
        console.warn("cloud save ì‹¤íŒ¨:", e);
      }
    }

    // ìµœì´ˆ ë¡œê·¸ì¸ ì‹œ: ë¡œì»¬ vs í´ë¼ìš°ë“œ ì„ íƒ
    async function firstSyncDecision(uid) {
      const remote = await cloudLoad(uid);

      // í´ë¼ìš°ë“œì— ì•„ë¬´ê²ƒë„ ì—†ìœ¼ë©´: ë¡œì»¬ì„ ì˜¬ë¦°ë‹¤
      if (!remote || (!remote.tree && !remote.logs)) {
        cloudReady = true;
        await cloudSave(uid);
        return;
      }

      const hasLocal = !!localStorage.getItem(TREE_STORAGE_KEY) || !!localStorage.getItem(LOG_STORAGE_KEY);
      const hasRemote = !!remote.tree || (Array.isArray(remote.logs) && remote.logs.length > 0);

      // ë‘˜ ë‹¤ ìˆìœ¼ë©´ ì„ íƒ
      if (hasLocal && hasRemote) {
        const chooseLocal = confirm(
          "í´ë¼ìš°ë“œì— ê¸°ì¡´ ë°ì´í„°ê°€ ìˆì–´ìš”.\n\n" +
          "í™•ì¸(OK) = í˜„ì¬ PC(ë¡œì»¬) ë°ì´í„°ë¥¼ í´ë¼ìš°ë“œì— ì—…ë¡œë“œ(ë®ì–´ì“°ê¸°)\n" +
          "ì·¨ì†Œ(Cancel) = í´ë¼ìš°ë“œ ë°ì´í„°ë¥¼ ë‚´ë ¤ë°›ì•„ í˜„ì¬ PCë¥¼ í´ë¼ìš°ë“œë¡œ ë§ì¶”ê¸°"
        );

        if (chooseLocal) {
          cloudReady = true;
          await cloudSave(uid);
        } else {
          // í´ë¼ìš°ë“œë¡œ ë®ì–´ì“°ê¸°
          applyRemoteData(remote);
          saveTreeLocal();
          saveLogsLocal();
          cloudReady = true;
        }
        return;
      }

      // ë¡œì»¬ë§Œ ìˆìœ¼ë©´: ë¡œì»¬ì„ ì˜¬ë¦°ë‹¤
      if (hasLocal && !hasRemote) {
        cloudReady = true;
        await cloudSave(uid);
        return;
      }

      // í´ë¼ìš°ë“œë§Œ ìˆìœ¼ë©´: í´ë¼ìš°ë“œë¥¼ ì ìš©í•œë‹¤
      if (!hasLocal && hasRemote) {
        applyRemoteData(remote);
        saveTreeLocal();
        saveLogsLocal();
        cloudReady = true;
        return;
      }

      // ë‘˜ ë‹¤ ì—†ìŒ
      cloudReady = true;
    }

    function applyRemoteData(remote) {
      try {
        isApplyingRemote = true;
        if (remote.tree && remote.tree.id && Array.isArray(remote.tree.children)) {
          tree = remote.tree;
          currentParentId = "root";
        }
        if (Array.isArray(remote.logs)) {
          logs = remote.logs;
        }
        renderLogs();
        render();
      } finally {
        isApplyingRemote = false;
      }
    }

    /***********************
     * 4) ë¡œì»¬ ì €ì¥/ë¶ˆëŸ¬ì˜¤ê¸°
     ***********************/
    function saveTreeLocal() {
      try {
        localStorage.setItem(TREE_STORAGE_KEY, JSON.stringify(tree));
      } catch (e) {
        console.warn("localStorage íŠ¸ë¦¬ ì €ì¥ ì˜¤ë¥˜:", e);
      }
    }

    function loadTreeLocal() {
      let saved = null;
      try {
        saved = localStorage.getItem(TREE_STORAGE_KEY);
      } catch (e) {
        console.warn("localStorage íŠ¸ë¦¬ ì ‘ê·¼ ì˜¤ë¥˜:", e);
      }

      if (saved) {
        try {
          const parsed = JSON.parse(saved);
          if (parsed && parsed.id && Array.isArray(parsed.children)) {
            tree = parsed;
            return;
          }
        } catch (e) {
          console.warn("íŠ¸ë¦¬ íŒŒì‹± ì‹¤íŒ¨, ê¸°ë³¸ê°’ìœ¼ë¡œ ì´ˆê¸°í™”:", e);
        }
      }

      // ì´ˆê¸° ì˜ˆì‹œ íŠ¸ë¦¬
      tree = {
        id: "root",
        label: "ROOT",
        children: [
          { id: genId(), label: "ì˜ˆì‹œ ë²„íŠ¼ 1", children: [] },
          {
            id: genId(),
            label: "ì˜ˆì‹œ ë²„íŠ¼ 2",
            children: [
              { id: genId(), label: "ì˜ˆì‹œ 2-1", children: [] },
              { id: genId(), label: "ì˜ˆì‹œ 2-2", children: [] }
            ]
          }
        ]
      };
      saveTreeLocal();
    }

    function saveLogsLocal() {
      try {
        localStorage.setItem(LOG_STORAGE_KEY, JSON.stringify(logs));
      } catch (e) {
        console.warn("localStorage ë¡œê·¸ ì €ì¥ ì˜¤ë¥˜:", e);
      }
    }

    function loadLogsLocal() {
      let saved = null;
      try {
        saved = localStorage.getItem(LOG_STORAGE_KEY);
      } catch (e) {
        console.warn("localStorage ë¡œê·¸ ì ‘ê·¼ ì˜¤ë¥˜:", e);
      }

      if (saved) {
        try {
          const parsed = JSON.parse(saved);
          if (Array.isArray(parsed)) {
            logs = parsed;
          }
        } catch (e) {
          console.warn("ë¡œê·¸ íŒŒì‹± ì‹¤íŒ¨, ë¹ˆ ë°°ì—´ë¡œ ì´ˆê¸°í™”:", e);
          logs = [];
        }
      } else {
        logs = [];
      }
      renderLogs();
    }

    // ì €ì¥ í›…: ë¡œì»¬ ì €ì¥ + (ë¡œê·¸ì¸ ì‹œ) í´ë¼ìš°ë“œ ì €ì¥
    function saveTree() {
      saveTreeLocal();
      if (currentUser) cloudSave(currentUser.uid);
    }
    function saveLogs() {
      saveLogsLocal();
      if (currentUser) cloudSave(currentUser.uid);
    }

    /***********************
     * 5) íŠ¸ë¦¬ ìœ í‹¸
     ***********************/
    function findNodeById(node, id) {
      if (!node) return null;
      if (node.id === id) return node;
      const children = node.children || [];
      for (let i = 0; i < children.length; i++) {
        const found = findNodeById(children[i], id);
        if (found) return found;
      }
      return null;
    }

    function findParentId(root, targetId, parentId) {
      if (root.id === targetId) return parentId;
      const children = root.children || [];
      for (let i = 0; i < children.length; i++) {
        const found = findParentId(children[i], targetId, root.id);
        if (found !== null && found !== undefined) return found;
      }
      return null;
    }

    // ê¹Šì´(ë£¨íŠ¸=0, ë£¨íŠ¸ ìì‹=1, ...)
    function getDepthById(node, targetId, depth) {
      if (depth === undefined) depth = 0;
      if (!node) return -1;
      if (node.id === targetId) return depth;
      const children = node.children || [];
      for (let i = 0; i < children.length; i++) {
        const d = getDepthById(children[i], targetId, depth + 1);
        if (d !== -1) return d;
      }
      return -1;
    }

    // 1 â†’ A, 2 â†’ B, ... 26 â†’ Z, 27 â†’ AA ...
    function columnIndexToLetters(n) {
      if (!n || n <= 0) n = 1;
      let s = "";
      while (n > 0) {
        const rem = (n - 1) % 26;
        s = String.fromCharCode(65 + rem) + s;
        n = Math.floor((n - 1) / 26);
      }
      return s;
    }

    function getCurrentParentNode() {
      const node = findNodeById(tree, currentParentId);
      return node || tree;
    }

    function moveSibling(parentNode, index, delta) {
      if (!parentNode || !parentNode.children) return;
      const newIndex = index + delta;
      if (newIndex < 0 || newIndex >= parentNode.children.length) return;
      const arr = parentNode.children;
      const tmp = arr[index];
      arr[index] = arr[newIndex];
      arr[newIndex] = tmp;
      saveTree();
      render();
    }

    /***********************
     * 6) ë¡œê·¸ ë Œë”ë§
     ***********************/
    function updateLogCount() {
      const countSpan = document.getElementById("logCount");
      if (!countSpan) return;
      countSpan.textContent = logs.length;
    }

    function createLogLi(log, index) {
      const li = document.createElement("li");
      li.dataset.index = index; // logs ë°°ì—´ ì¸ë±ìŠ¤

      const checkbox = document.createElement("input");
      checkbox.type = "checkbox";
      checkbox.className = "log-checkbox";

      const textSpan = document.createElement("span");
      textSpan.className = "log-text";
      textSpan.textContent = `${log.time} - [${log.coord}] ${log.label}`;

      li.appendChild(checkbox);
      li.appendChild(textSpan);
      return li;
    }

    function renderLogs() {
      const logList = document.getElementById("logList");
      if (!logList) return;
      logList.innerHTML = "";

      logs.forEach((log, idx) => {
        const li = createLogLi(log, idx);
        logList.appendChild(li);
      });

      updateLogCount();
    }

    function appendLog(label, coord) {
      const now = new Date();
      const timeStr = now.toLocaleString();

      // ìµœì‹  ë¡œê·¸ë¥¼ ë°°ì—´ì˜ ì•ì— ë„£ê¸°
      logs.unshift({
        time: timeStr,
        label: label,
        coord: coord
      });

      saveLogs();
      renderLogs();
    }

    function getSelectedLogItems() {
      const logList = document.getElementById("logList");
      if (!logList) return [];
      const items = Array.from(logList.querySelectorAll("li"));
      return items.filter(li => {
        const cb = li.querySelector(".log-checkbox");
        return cb && cb.checked;
      });
    }

    function deleteSelectedLogs() {
      const selected = getSelectedLogItems();
      if (selected.length === 0) {
        alert("ì‚­ì œí•  ê¸°ë¡ì„ ì„ íƒí•˜ì„¸ìš”.");
        return;
      }
      if (!confirm(selected.length + "ê°œì˜ ê¸°ë¡ì„ ì‚­ì œí• ê¹Œìš”?")) return;

      const indexes = selected
        .map(li => Number(li.dataset.index))
        .filter(n => !Number.isNaN(n))
        .sort((a, b) => b - a);

      indexes.forEach(idx => {
        if (idx >= 0 && idx < logs.length) {
          logs.splice(idx, 1);
        }
      });

      saveLogs();
      renderLogs();
    }

    function editSelectedLog() {
      const selected = getSelectedLogItems();
      if (selected.length === 0) {
        alert("ìˆ˜ì •í•  ê¸°ë¡ì„ ì„ íƒí•˜ì„¸ìš”.");
        return;
      }
      if (selected.length > 1) {
        alert("í•œ ë²ˆì— í•˜ë‚˜ì˜ ê¸°ë¡ë§Œ ìˆ˜ì •í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.");
        return;
      }

      const li = selected[0];
      const idx = Number(li.dataset.index);
      if (Number.isNaN(idx) || idx < 0 || idx >= logs.length) {
        alert("ë¡œê·¸ ì¸ë±ìŠ¤ ì˜¤ë¥˜ì…ë‹ˆë‹¤.");
        return;
      }

      const old = logs[idx];
      const newLabel = prompt("ìƒˆ ë‚´ìš©(ë¼ë²¨)ì„ ì…ë ¥í•˜ì„¸ìš”:", old.label);
      if (!newLabel || newLabel.trim() === "") return;

      logs[idx].label = newLabel.trim();
      saveLogs();
      renderLogs();
    }

    /***********************
     * 7) í´ë¦½ë³´ë“œ
     ***********************/
    function copyTextWithClipboard(text, count, label) {
      if (navigator.clipboard && navigator.clipboard.writeText) {
        navigator.clipboard.writeText(text)
          .then(() => {
            alert(label + " ê¸°ë¡ì´ í´ë¦½ë³´ë“œì— ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤. (" + count + "ê°œ)");
          })
          .catch(err => {
            console.warn("clipboard API ì‹¤íŒ¨, execCommandë¡œ ì‹œë„:", err);
            fallbackCopyText(text, count, label);
          });
      } else {
        fallbackCopyText(text, count, label);
      }
    }

    function fallbackCopyText(text, count, label) {
      const textarea = document.createElement("textarea");
      textarea.value = text;
      textarea.style.position = "fixed";
      textarea.style.top = "-9999px";
      document.body.appendChild(textarea);
      textarea.select();
      try {
        document.execCommand("copy");
        alert(label + " ê¸°ë¡ì´ í´ë¦½ë³´ë“œì— ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤. (" + count + "ê°œ)");
      } catch (e) {
        alert("ë³µì‚¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ì§ì ‘ ì„ íƒí•´ì„œ ë³µì‚¬í•´ ì£¼ì„¸ìš”.");
        console.error(e);
      }
      document.body.removeChild(textarea);
    }

    function copyAllLogs() {
      if (logs.length === 0) {
        alert("ë³µì‚¬í•  ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.");
        return;
      }
      const lines = logs.map(log => `${log.time} - [${log.coord}] ${log.label}`);
      copyTextWithClipboard(lines.join("\n"), lines.length, "ì „ì²´");
    }

    function copySelectedLogs() {
      const selected = getSelectedLogItems();
      if (selected.length === 0) {
        alert("ë³µì‚¬í•  ê¸°ë¡ì„ ì„ íƒí•˜ì„¸ìš”.");
        return;
      }

      const indexes = selected
        .map(li => Number(li.dataset.index))
        .filter(n => !Number.isNaN(n))
        .sort((a, b) => a - b);

      const lines = indexes.map(idx => {
        const log = logs[idx];
        return `${log.time} - [${log.coord}] ${log.label}`;
      });

      copyTextWithClipboard(lines.join("\n"), lines.length, "ì„ íƒí•œ");
    }

    /***********************
     * 8) í™”ë©´ ë Œë”ë§ (íŠ¸ë¦¬)
     ***********************/
    function updateBreadcrumb() {
      const bc = document.getElementById("breadcrumb");
      if (!bc) return;

      if (currentParentId === "root") {
        bc.textContent = "ìœ„ì¹˜: ROOT";
        return;
      }

      const pathNodes = [];
      function dfs(node, targetId, path) {
        path.push(node);
        if (node.id === targetId) return true;
        const children = node.children || [];
        for (let i = 0; i < children.length; i++) {
          if (dfs(children[i], targetId, path)) return true;
        }
        path.pop();
        return false;
      }

      dfs(tree, currentParentId, pathNodes);
      const names = pathNodes.map(n => n.label);
      bc.textContent = "ìœ„ì¹˜: " + names.join(" > ");
    }

    function renderButtons() {
      const container = document.getElementById("buttonContainer");
      if (!container) return;
      container.innerHTML = "";

      const parentNode = getCurrentParentNode();
      const children = parentNode.children || [];

      let parentDepth = getDepthById(tree, parentNode.id, 0);
      if (parentDepth < 0) parentDepth = 0;
      const childDepth = parentDepth + 1;
      const colLetters = columnIndexToLetters(childDepth);

      if (children.length === 0) {
        const div = document.createElement("div");
        div.className = "empty-text";
        div.textContent = "ì´ ìœ„ì¹˜ì—ëŠ” ë²„íŠ¼ì´ ì—†ìŠµë‹ˆë‹¤. ì•„ë˜ì—ì„œ ìƒˆ ë²„íŠ¼ì„ ì¶”ê°€í•˜ì„¸ìš”.";
        container.appendChild(div);
        return;
      }

      children.forEach((child, index) => {
        const row = document.createElement("div");
        row.className = "btn-row";

        const rowNumber = index + 1;
        const coord = colLetters + rowNumber; // ì˜ˆ: A1, A2, B1 ...

        const mainBtn = document.createElement("button");
        mainBtn.className = "btn-main";
        mainBtn.textContent = "[" + coord + "] " + child.label;

        mainBtn.addEventListener("click", () => {
          if (child.children && child.children.length > 0) {
            currentParentId = child.id;
            render();
          } else {
            appendLog(child.label, coord);
          }
        });

        const controls = document.createElement("div");
        controls.className = "btn-controls";

        const upBtn = document.createElement("button");
        upBtn.textContent = "â†‘";
        upBtn.title = "ìœ„ë¡œ";
        upBtn.addEventListener("click", () => {
          moveSibling(parentNode, index, -1);
        });

        const downBtn = document.createElement("button");
        downBtn.textContent = "â†“";
        downBtn.title = "ì•„ë˜ë¡œ";
        downBtn.addEventListener("click", () => {
          moveSibling(parentNode, index, 1);
        });

        const addChildBtn = document.createElement("button");
        addChildBtn.textContent = "+í•˜ìœ„";
        addChildBtn.title = "í•˜ìœ„ ë²„íŠ¼ ì¶”ê°€";
        addChildBtn.addEventListener("click", () => {
          const name = prompt("í•˜ìœ„ ë²„íŠ¼ ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”:");
          if (name && name.trim() !== "") {
            if (!child.children) child.children = [];
            child.children.push({
              id: genId(),
              label: name.trim(),
              children: []
            });
            saveTree();
            render();
          }
        });

        const renameBtn = document.createElement("button");
        renameBtn.textContent = "ì´ë¦„ë³€ê²½";
        renameBtn.title = "ë²„íŠ¼ ì´ë¦„ ë³€ê²½";
        renameBtn.addEventListener("click", () => {
          const newName = prompt("ìƒˆ ë²„íŠ¼ ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”:", child.label);
          if (newName && newName.trim() !== "") {
            child.label = newName.trim();
            saveTree();
            render();
          }
        });

        const delBtn = document.createElement("button");
        delBtn.textContent = "ì‚­ì œ";
        delBtn.title = "ì´ ë²„íŠ¼ ì‚­ì œ";
        delBtn.addEventListener("click", () => {
          if (!confirm("'" + child.label + "' ë²„íŠ¼ì„ ì‚­ì œí• ê¹Œìš”? (í•˜ìœ„ ë²„íŠ¼ë„ í•¨ê»˜ ì‚­ì œë©ë‹ˆë‹¤)")) return;
          parentNode.children.splice(index, 1);
          saveTree();
          render();
        });

        controls.appendChild(upBtn);
        controls.appendChild(downBtn);
        controls.appendChild(addChildBtn);
        controls.appendChild(renameBtn);
        controls.appendChild(delBtn);

        row.appendChild(mainBtn);
        row.appendChild(controls);
        container.appendChild(row);
      });
    }

    function render() {
      updateBreadcrumb();
      renderButtons();
      updateLogCount();
    }

    /***********************
     * 9) ì´ˆê¸°í™” & ì´ë²¤íŠ¸
     ***********************/
    // ë¡œì»¬ë¶€í„° ë¡œë“œ
    loadTreeLocal();
    loadLogsLocal();
    render();


    document.getElementById("btnUp").addEventListener("click", () => {
      if (currentParentId === "root") return;
      const parentId = findParentId(tree, currentParentId, null);
      currentParentId = parentId || "root";
      render();
    });

    document.getElementById("btnRoot").addEventListener("click", () => {
      currentParentId = "root";
      render();
    });

    document.getElementById("btnAddHere").addEventListener("click", () => {
      const parentNode = getCurrentParentNode();
      const name = prompt("ìƒˆ ë²„íŠ¼ ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”:");
      if (name && name.trim() !== "") {
        if (!parentNode.children) parentNode.children = [];
        parentNode.children.push({
          id: genId(),
          label: name.trim(),
          children: []
        });
        saveTree();
        render();
      }
    });

    document.getElementById("btnDeleteLog").addEventListener("click", deleteSelectedLogs);
    document.getElementById("btnEditLog").addEventListener("click", editSelectedLog);
    document.getElementById("btnCopyAllLog").addEventListener("click", copyAllLogs);
    document.getElementById("btnCopySelectedLog").addEventListener("click", copySelectedLogs);

    // ë¡œê·¸ì¸ ë²„íŠ¼
    document.getElementById("btnLogin").addEventListener("click", async () => {
      try {
        // íŒì—…ì´ ë§‰íˆë©´ redirectë¡œ ë°”ê¿”ë„ ë¨:
        // await auth.signInWithRedirect(provider);
        await auth.signInWithPopup(provider);
      } catch (e) {
        console.error(e);
        alert("ë¡œê·¸ì¸ ì‹¤íŒ¨: íŒì—…ì´ ì°¨ë‹¨ëì„ ìˆ˜ ìˆì–´ìš”. íŒì—… í—ˆìš© í›„ ë‹¤ì‹œ ì‹œë„í•˜ì„¸ìš”.");
      }
    });

    // ë¡œê·¸ì•„ì›ƒ ë²„íŠ¼
    document.getElementById("btnLogout").addEventListener("click", async () => {
      try {
        await auth.signOut();
      } catch (e) {
        console.error(e);
      }
    });

    // ì¸ì¦ ìƒíƒœ ë³€í™” ê°ì§€
    auth.onAuthStateChanged(async (user) => {
      currentUser = user || null;
      cloudReady = false;
      setAuthUI();

      if (!currentUser) {
        // ë¡œì»¬ ëª¨ë“œë¡œ ê³„ì†
        return;
      }

      // ë¡œê·¸ì¸ ì‹œ ìµœì´ˆ ë™ê¸°í™” ê²°ì •
      try {
        await firstSyncDecision(currentUser.uid);
        cloudReady = true;
        // ì„ íƒ í›„ ìµœì‹  ìƒíƒœë¥¼ í•œ ë²ˆ ë” ì €ì¥(ì •í•©ì„±)
        await cloudSave(currentUser.uid);
      } catch (e) {
        console.error(e);
        alert("í´ë¼ìš°ë“œ ë™ê¸°í™” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ì½˜ì†” ë¡œê·¸ë¥¼ í™•ì¸í•˜ì„¸ìš”.");
      }
    });

    // ì²˜ìŒ UI ìƒíƒœ
    setAuthUI();
  </script>
</body>
</html>

