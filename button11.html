<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>복한아름 기록공책</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    * { box-sizing: border-box; font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif; }
    body { margin: 0; padding: 10px; background: #f5f5f5; }

    .app {
      max-width: 900px; margin: 0 auto; background: #ffffff; border-radius: 12px;
      padding: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    }
    h1 { margin: 0 0 8px; font-size: 18px; display:flex; align-items:center; justify-content:space-between; gap:8px; flex-wrap:wrap;}
    .badge { font-size:12px; border:1px solid #ddd; border-radius:999px; padding:4px 10px; background:#fafafa; }

    button { cursor: pointer; border-radius: 8px; border: 1px solid #ddd; background: #fff; padding: 6px 10px; font-size: 13px; }
    button:active { transform: scale(0.97); }
    button:disabled { opacity: .5; cursor: not-allowed; }

    :root{
      --btnWidthPct: 39;
      --manualWidthPct: 70;
    }

    .layout { display: flex; flex-direction: column; gap: 6px; }
    @media (min-width: 720px) {
      .layout { flex-direction: row; gap: 6px; height: calc(100vh - 240px); }
      .left, .right { height: 100%; }
      .panel-shell { height: 100%; }
      .panel-scroll { height: 100%; }
    }
    .left, .right { flex: 1; min-width: 0; }

    .panel-shell{ display:flex; flex-direction:column; min-height: 0; }
    .panel-scroll { flex: 1; min-height: 0; overflow: hidden; }

    .panel-head {
      display: flex; align-items: center; gap: 8px;
      margin-bottom: 4px; flex-wrap: wrap;
    }
    .panel-title { font-size: 14px; font-weight: 600; }
    .nav-inline { margin-left: auto; display: flex; gap: 6px; align-items: center; flex-wrap: wrap; }
    .nav-inline small { opacity: .8; }

    .mode-bar{
      display:flex; gap:6px; align-items:center; flex-wrap:wrap;
      margin: 6px 0 10px;
    }
    .mode-bar button{ font-size:12px; padding:6px 10px; border-radius:10px; }
    .mode-bar button.active{ background:#eef7ff; border-color:#b3d4ff; }
    .mode-bar .hint{ font-size:12px; opacity:.75; margin-left:auto; }

    .chips-wrap{
      border: 1px solid #eee;
      border-radius: 12px;
      padding: 8px;
      background: #fafafa;
      margin: 6px 0 8px;
      overflow-x: auto;
      -webkit-overflow-scrolling: touch;
      white-space: nowrap;
    }
    .chips{ display:inline-flex; gap:8px; align-items:center; }
    .chip{
      display:inline-flex; align-items:center; gap:6px;
      padding:8px 12px; border-radius:999px;
      border:1px solid #ddd; background:#fff; font-size:13px;
      cursor:pointer; user-select:none; white-space:nowrap;
    }
    .chip:hover{ background:#f6f6f6; }
    .chip.active{ background:#eef7ff; border-color:#b3d4ff; font-weight:700; }
    .chip .dot{ width:6px; height:6px; border-radius:999px; background:#bbb; display:inline-block; }
    .chip.active .dot{ background:#4c8dff; }
    .chip-sep{ opacity:.35; font-size:14px; user-select:none; }

    .design-panel{
      display:none;
      border: 1px dashed #ddd;
      border-radius: 10px;
      padding: 10px;
      background:#fbfbfb;
      margin: 6px 0 8px;
    }
    .design-panel.show{ display:block; }
    .design-row{ display:flex; gap:10px; align-items:center; flex-wrap:wrap; }
    .design-row label{ font-size:12px; opacity:.85; display:flex; gap:8px; align-items:center; }
    .design-row input[type="range"]{ width:220px; }
    .kv{ font-size:12px; opacity:.75; }

    .quick-add { display: flex; gap: 6px; align-items: flex-start; margin: 6px 0 8px; }
    .quick-add textarea {
      flex: 0 0 auto;
      width: calc(var(--manualWidthPct) * 1%);
      min-width: 120px;
      border: 1px solid #ddd; border-radius: 10px;
      padding: 8px 10px; font-size: 13px; outline: none;
      resize: vertical; min-height: 42px; max-height: 240px;
      line-height: 1.35;
      white-space: pre-wrap;
    }
    .quick-add textarea:focus { border-color: #b3d4ff; box-shadow: 0 0 0 3px rgba(179, 212, 255, 0.35); }
    .quick-add button { white-space: nowrap; padding: 8px 10px; }
    .btn-primary { background: #eef7ff; border-color: #b3d4ff; }

    .buttons-area {
      margin-top: 6px; margin-bottom: 10px;
      overflow-y: auto; padding-right: 4px;
      flex: 0 0 auto; min-height: 0;
      max-height: 50vh;
      border: 1px solid #eee; border-radius: 10px;
      padding: 6px; background: #fff;
      -webkit-overflow-scrolling: touch;
      overscroll-behavior: contain;
    }

    .btn-row {
      display: flex;
      align-items: center;
      gap: 4px;
      margin-bottom: 6px;
      flex-wrap: nowrap;
      justify-content: flex-start;
    }
    .row-check{
      width: 26px;
      display:flex;
      align-items:center;
      justify-content:center;
      flex: 0 0 auto;
    }
    .row-check input{
      width: 16px; height: 16px;
      cursor: pointer;
    }

    .btn-main{
      flex: 0 0 auto;
      width: calc(var(--btnWidthPct) * 1%);
      text-align: left; padding: 10px;
      border-radius: 10px; border: 1px solid #ccc;
      background: #fafafa; font-size: 14px; min-height: 40px;
      transition: width .08s linear;
      min-width: 120px;
    }
    .btn-main:focus{ outline:none; box-shadow: 0 0 0 3px rgba(179, 212, 255, 0.35); border-color:#b3d4ff; }

    .btn-controls {
      flex: 0 0 auto;
      display: inline-flex;
      gap: 2px;
      white-space: nowrap;
    }
    .btn-controls button { padding: 4px 6px; font-size: 11px; }
    .btn-controls .btn-insert { background:#eef7ff; border-color:#b3d4ff; }

    .add-row{ display:flex; gap:6px; align-items:center; }
    .add-row button{ flex:1; }
    .add-current { margin: 4px 0 10px; width: 100%; background: #eef7ff; border-color: #b3d4ff; }

    .log-header { display: flex; align-items: baseline; gap: 6px; margin-bottom: 4px; flex-wrap: wrap; }
    .log-count { font-size: 12px; opacity: 0.7; }
    .log-actions { margin-left: auto; display: flex; gap: 4px; flex-wrap: wrap; }

    .log-box {
      background: #fafafa; border-radius: 10px; border: 1px solid #ddd; padding: 8px;
      overflow-y: auto; flex: 1; min-height: 0; max-height: none;
    }
    #logList { list-style: none; padding: 0; margin: 0; font-size: 12px; }
    #logList li {
      padding: 6px 2px; border-bottom: 1px solid #eee;
      word-break: break-all;
      display: flex; align-items: flex-start; gap: 6px;
      white-space: pre-wrap;
    }
    #logList li:last-child { border-bottom: none; }
    .log-text { flex: 1; white-space: pre-wrap; line-height: 1.35; }
    .log-checkbox { flex-shrink: 0; margin-top: 2px; }

    .empty-text { font-size: 12px; opacity: 0.75; line-height: 1.45; white-space: pre-wrap; }
    .help-edit-btn { margin-top: 6px; width: 100%; font-size: 12px; padding: 6px 10px; }
    .help-box { border: 1px dashed #ddd; border-radius: 10px; padding: 10px; background: #fbfbfb; margin-top: 10px; }

    .moved-area { margin-top: 10px; border: 1px solid #eee; border-radius: 10px; padding: 10px; background: #fafafa; }
    .auth-bar { display:flex; gap:6px; align-items:center; flex-wrap:wrap; margin-bottom:8px; }
    .auth-status { font-size:12px; opacity:.85; }
    .note { font-size:12px; opacity:.75; margin:6px 0 0; }

    .modal-backdrop {
      position: fixed; inset: 0; background: rgba(0,0,0,0.35);
      display: none; align-items: center; justify-content: center; padding: 16px;
      z-index: 9999;
    }
    .modal { width: min(720px, 100%); background: #fff; border-radius: 12px; border: 1px solid #ddd;
      box-shadow: 0 10px 30px rgba(0,0,0,0.18); padding: 12px; }
    .modal h2 { font-size: 14px; margin: 0 0 8px; }

    .stat-grid{ display:grid; grid-template-columns: 1fr 1fr; gap:10px; }
    @media (max-width:520px){ .stat-grid{ grid-template-columns:1fr; } }
    .stat-card{ border:1px solid #eee; border-radius:12px; padding:10px; background:#fafafa; }
    .stat-k{ font-size:12px; opacity:.75; }
    .stat-v{ font-size:18px; font-weight:800; margin-top:4px; }
  </style>
</head>
<body>
  <div class="app">
    <h1>
      복한아름 기록공책
      <span class="badge" id="syncBadge">로컬 모드</span>
    </h1>

    <div class="mode-bar">
      <button id="btnDesignMode">디자인모드</button>
      <button id="btnStatsMode">통계모드</button>
      <div class="hint" id="modeHint"></div>
    </div>

    <div class="layout">
      <div class="left panel-shell">
        <div class="panel-head">
          <div class="panel-title">버튼 목록</div>
          <div class="nav-inline">
            <button id="btnUp">◀ 상위로</button>
            <button id="btnRoot">⬆ 최상위로</button>
            <small id="breadcrumb">위치: ROOT</small>
          </div>
        </div>

        <div class="chips-wrap">
          <div class="chips" id="pathChips"></div>
        </div>

        <div class="design-panel" id="designPanel">
          <div class="design-row">
            <label>
              버튼 길이(%)
              <input id="rangeBtnWidth" type="range" min="15" max="100" value="39" />
              <span class="kv"><span id="valBtnWidth">39</span>%</span>
            </label>

            <label>
              직접입력 길이(%)
              <input id="rangeManualW" type="range" min="20" max="100" value="70" />
              <span class="kv"><span id="valManualW">70</span>%</span>
            </label>
          </div>
          <div class="kv" style="margin-top:6px;">※ 디자인모드에서만 조절. (왼쪽 버튼 폭 + 직접입력칸 폭)</div>
        </div>

        <div class="panel-scroll" style="display:flex; flex-direction:column; min-height:0;">
          <div class="quick-add">
            <textarea id="quickAddInput" placeholder="여기에 입력 후 Enter (오른쪽 클릭 기록에 저장)&#10;Shift+Enter = 줄바꿈"></textarea>
            <button id="btnQuickAdd" class="btn-primary">기록</button>
          </div>

          <div class="buttons-area" id="buttonContainer"></div>

          <div class="add-row">
            <button class="add-current" id="btnAddHere">+새버튼</button>
            <button class="add-current" id="btnAddChild">+하위버튼</button>
          </div>
        </div>
      </div>

      <div class="right panel-shell">
        <div class="log-header">
          <div class="panel-title">클릭 기록</div>
          <div class="log-count">(총 <span id="logCount">0</span>개)</div>
          <div class="log-actions">
            <button id="btnSelectAllLog" style="font-size:11px;padding:4px 6px;">전체 선택</button>
            <button id="btnCopyAllLog" style="font-size:11px;padding:4px 6px;">전체 복사</button>
            <button id="btnCopySelectedLog" style="font-size:11px;padding:4px 6px;">선택 복사</button>
            <button id="btnEditLog" style="font-size:11px;padding:4px 6px;">선택 수정</button>
            <button id="btnDeleteLog" style="font-size:11px;padding:4px 6px;">선택 삭제</button>
          </div>
        </div>

        <div class="panel-scroll" style="display:flex; flex-direction:column; min-height:0;">
          <div class="log-box">
            <ul id="logList"></ul>
          </div>
        </div>
      </div>
    </div>

    <div class="moved-area">
      <div class="auth-bar">
        <button id="btnLogin">Google 로그인</button>
        <button id="btnLogout" disabled>로그아웃</button>
        <span class="auth-status" id="authStatus">로그인 안 됨</span>
      </div>
      <div class="note">※ 로그인하면 <b>항상 클라우드 데이터가 우선</b> 적용됩니다. (로컬은 자동으로 클라우드로 맞춰짐)</div>
    </div>
  </div>

  <div class="modal-backdrop" id="statsBackdrop">
    <div class="modal">
      <h2>통계</h2>
      <div class="stat-grid">
        <div class="stat-card">
          <div class="stat-k">클릭 기록 개수</div>
          <div class="stat-v" id="statCount">0</div>
        </div>
        <div class="stat-card">
          <div class="stat-k">클릭 기록 글자수(내용 합)</div>
          <div class="stat-v" id="statChars">0</div>
        </div>
        <div class="stat-card">
          <div class="stat-k">버튼 개수(트리 전체)</div>
          <div class="stat-v" id="statBtns">0</div>
        </div>
        <div class="stat-card">
          <div class="stat-k">현재 위치 버튼 개수</div>
          <div class="stat-v" id="statHereBtns">0</div>
        </div>
      </div>
      <div class="modal-actions" style="margin-top:12px; display:flex; justify-content:flex-end;">
        <button id="btnStatsClose">닫기</button>
      </div>
    </div>
  </div>

  <script src="https://www.gstatic.com/firebasejs/10.12.5/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.5/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore-compat.js"></script>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyC8kLsUhGLu4eGhTYlKlh-tKCQkKjF0EvU",
      authDomain: "button-tree.firebaseapp.com",
      projectId: "button-tree",
      storageBucket: "button-tree.firebasestorage.app",
      messagingSenderId: "670872655484",
      appId: "1:670872655484:web:a8f5a5201cd845a4075bf9",
      measurementId: "G-9P3ZV8LLQ3"
    };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();
    const provider = new firebase.auth.GoogleAuthProvider();

    const TREE_STORAGE_KEY = "buttonTree_v_local";
    const LOG_STORAGE_KEY  = "buttonLogs_v1";
    const UI_STORAGE_KEY   = "buttonUI_v1";

    const BACKUP_WARN_THRESHOLD = 1000;

    let tree = null;
    let currentParentId = "root";
    let logs = [];
    let ui = { designMode: false, btnWidthPct: 39, manualWidthPct: 70 };

    let currentUser = null;
    let unsubscribeDoc = null;
    let isApplyingRemote = false;
    let saveTimer = null;

    // ✅ 체크리스트: 다중 체크 허용
    // 다만, "하위버튼 추가 대상"은 마지막으로 체크한 버튼(명확한 기준)
    let lastCheckedButtonId = null;

    function showBackupWarningIfNeeded() {
      if (!Array.isArray(logs)) return;
      if (logs.length < BACKUP_WARN_THRESHOLD) return;
      alert("⚠ 클릭 기록이 1,000개 이상입니다.\n\n데이터 손실 위험이 있습니다.\n'전체 복사'로 주기적으로 백업하세요.");
    }

    function genId() { return "id_" + Date.now().toString(36) + "_" + Math.random().toString(36).slice(2, 8); }
    function nowMs() { return Date.now(); }

    function setAuthUI() {
      const status = document.getElementById("authStatus");
      const btnLogin = document.getElementById("btnLogin");
      const btnLogout = document.getElementById("btnLogout");
      const badge = document.getElementById("syncBadge");

      if (currentUser) {
        const name = currentUser.displayName || currentUser.email || "사용자";
        status.textContent = `로그인됨: ${name}`;
        btnLogin.disabled = true;
        btnLogout.disabled = false;
        badge.textContent = "클라우드 동기화";
      } else {
        status.textContent = "로그인 안 됨";
        btnLogin.disabled = false;
        btnLogout.disabled = true;
        badge.textContent = "로컬 모드";
      }
    }
    function userDocRef(uid) { return db.collection("users").doc(uid); }

    function applyUI() {
      document.documentElement.style.setProperty("--btnWidthPct", String(ui.btnWidthPct));
      document.documentElement.style.setProperty("--manualWidthPct", String(ui.manualWidthPct));

      document.getElementById("btnDesignMode").classList.toggle("active", !!ui.designMode);
      document.getElementById("designPanel").classList.toggle("show", !!ui.designMode);

      document.getElementById("modeHint").textContent = ui.designMode ? "디자인모드 ON" : "";

      document.getElementById("rangeBtnWidth").value = String(ui.btnWidthPct);
      document.getElementById("valBtnWidth").textContent = String(ui.btnWidthPct);

      document.getElementById("rangeManualW").value = String(ui.manualWidthPct);
      document.getElementById("valManualW").textContent = String(ui.manualWidthPct);
    }

    function saveUILocal() { try { localStorage.setItem(UI_STORAGE_KEY, JSON.stringify(ui)); } catch {} }
    function loadUILocal() {
      try {
        const saved = localStorage.getItem(UI_STORAGE_KEY);
        if (saved) {
          const parsed = JSON.parse(saved);
          if (parsed && typeof parsed === "object") {
            ui = { ...ui, ...parsed };
            if (typeof ui.manualWidthPct !== "number") ui.manualWidthPct = 70;
          }
        }
      } catch {}
      applyUI();
    }

    function scheduleCloudSave() {
      if (!currentUser) return;
      if (isApplyingRemote) return;

      clearTimeout(saveTimer);
      saveTimer = setTimeout(async () => {
        try {
          await userDocRef(currentUser.uid).set({
            tree, logs, ui,
            updatedAtMs: nowMs(),
            updatedAt: firebase.firestore.FieldValue.serverTimestamp()
          }, { merge: true });
        } catch (e) { console.warn("cloud save 실패:", e); }
      }, 300);
    }

    function saveTreeLocal() { try { localStorage.setItem(TREE_STORAGE_KEY, JSON.stringify(tree)); } catch {} }
    function saveLogsLocal() { try { localStorage.setItem(LOG_STORAGE_KEY, JSON.stringify(logs)); } catch {} }

    function loadTreeLocal() {
      let saved = null;
      try { saved = localStorage.getItem(TREE_STORAGE_KEY); } catch {}
      if (saved) {
        try {
          const parsed = JSON.parse(saved);
          if (parsed && parsed.id && Array.isArray(parsed.children)) { tree = parsed; return; }
        } catch {}
      }
      tree = { id: "root", label: "ROOT", children: [] };
      saveTreeLocal();
    }

    function loadLogsLocal() {
      let saved = null;
      try { saved = localStorage.getItem(LOG_STORAGE_KEY); } catch {}
      if (saved) {
        try {
          const parsed = JSON.parse(saved);
          if (Array.isArray(parsed)) { logs = parsed; renderLogs(); return; }
        } catch {}
      }
      logs = [];
      renderLogs();
    }

    async function cloudLoad(uid) {
      const snap = await userDocRef(uid).get();
      if (!snap.exists) return null;
      return snap.data();
    }

    async function cloudFirstInit(uid) {
      const remote = await cloudLoad(uid);
      if (remote && (remote.tree || remote.logs || remote.ui)) {
        applyRemote(remote);
        saveTreeLocal(); saveLogsLocal(); saveUILocal();
        return;
      }
      await userDocRef(uid).set({
        tree, logs, ui,
        updatedAtMs: nowMs(),
        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
      }, { merge: true });
    }

    function findNodeById(node, id) {
      if (!node) return null;
      if (node.id === id) return node;
      const children = node.children || [];
      for (let i = 0; i < children.length; i++) {
        const found = findNodeById(children[i], id);
        if (found) return found;
      }
      return null;
    }

    function applyRemote(remote) {
      try {
        isApplyingRemote = true;

        const prevParentId = currentParentId;

        if (remote.tree && remote.tree.id && Array.isArray(remote.tree.children)) {
          tree = remote.tree;
          const stillExists = findNodeById(tree, prevParentId);
          currentParentId = stillExists ? prevParentId : "root";
        }
        if (Array.isArray(remote.logs)) logs = remote.logs;
        if (remote.ui && typeof remote.ui === "object") {
          ui = { ...ui, ...remote.ui };
          if (typeof ui.manualWidthPct !== "number") ui.manualWidthPct = 70;
        }

        // 마지막 체크 대상이 삭제되었을 경우 초기화
        if (lastCheckedButtonId && !findNodeById(tree, lastCheckedButtonId)) lastCheckedButtonId = null;

        applyUI();
        renderLogs();
        render();
        showBackupWarningIfNeeded();
      } finally { isApplyingRemote = false; }
    }

    function startRealtimeListener(uid) {
      if (unsubscribeDoc) unsubscribeDoc();
      unsubscribeDoc = userDocRef(uid).onSnapshot((snap) => {
        if (!snap.exists) return;
        const remote = snap.data() || {};
        if (isApplyingRemote) return;
        if (!remote.tree && !remote.logs && !remote.ui) return;

        applyRemote(remote);
        saveTreeLocal(); saveLogsLocal(); saveUILocal();
      }, (err) => console.warn("onSnapshot 오류:", err));
    }

    function saveTree() { saveTreeLocal(); scheduleCloudSave(); }
    function saveLogs() { saveLogsLocal(); scheduleCloudSave(); }

    function findParentId(root, targetId, parentId) {
      if (root.id === targetId) return parentId;
      const children = root.children || [];
      for (let i = 0; i < children.length; i++) {
        const found = findParentId(children[i], targetId, root.id);
        if (found !== null && found !== undefined) return found;
      }
      return null;
    }

    function getPathNodesToCurrent() {
      const path = [];
      function dfs(node, targetId) {
        path.push(node);
        if (node.id === targetId) return true;
        const children = node.children || [];
        for (let i = 0; i < children.length; i++) if (dfs(children[i], targetId)) return true;
        path.pop();
        return false;
      }
      dfs(tree, currentParentId === "root" ? "root" : currentParentId);
      return path;
    }

    function renderPathChips() {
      const wrap = document.getElementById("pathChips");
      wrap.innerHTML = "";

      const path = getPathNodesToCurrent();
      path.forEach((node, idx) => {
        if (idx > 0) {
          const sep = document.createElement("span");
          sep.className = "chip-sep";
          sep.textContent = "›";
          wrap.appendChild(sep);
        }

        const chip = document.createElement("div");
        chip.className = "chip";
        if (idx === path.length - 1) chip.classList.add("active");

        const dot = document.createElement("span");
        dot.className = "dot";

        const label = document.createElement("span");
        label.textContent = (node.id === "root") ? "전체" : (node.label || "이름없음");

        chip.appendChild(dot);
        chip.appendChild(label);

        chip.addEventListener("click", () => {
          currentParentId = (node.id === "root") ? "root" : node.id;
          render();
        });

        wrap.appendChild(chip);
      });
    }

    function getDepthById(node, targetId, depth) {
      if (depth === undefined) depth = 0;
      if (!node) return -1;
      if (node.id === targetId) return depth;
      const children = node.children || [];
      for (let i = 0; i < children.length; i++) {
        const d = getDepthById(children[i], targetId, depth + 1);
        if (d !== -1) return d;
      }
      return -1;
    }

    function columnIndexToLetters(n) {
      if (!n || n <= 0) n = 1;
      let s = "";
      while (n > 0) {
        const rem = (n - 1) % 26;
        s = String.fromCharCode(65 + rem) + s;
        n = Math.floor((n - 1) / 26);
      }
      return s;
    }

    function getCurrentParentNode() {
      const node = findNodeById(tree, currentParentId);
      if (!node) currentParentId = "root";
      return node || tree;
    }

    function moveSibling(parentNode, index, delta) {
      if (!parentNode || !parentNode.children) return;
      const newIndex = index + delta;
      if (newIndex < 0 || newIndex >= parentNode.children.length) return;
      const arr = parentNode.children;
      const tmp = arr[index];
      arr[index] = arr[newIndex];
      arr[newIndex] = tmp;
      saveTree();
      render();
    }

    function countAllButtons(node) {
      if (!node) return 0;
      const children = node.children || [];
      let sum = 0;
      for (const c of children) sum += 1 + countAllButtons(c);
      return sum;
    }

    // ✅ 클릭기록 표시 포맷: 시간 + 엔터 + 내용(좌표 포함)
    function formatLogText(log) {
      const coord = log.coord ?? "";
      const label = log.label ?? "";
      return `${log.time}\n[${coord}] ${label}`;
    }

    function updateLogCount() { document.getElementById("logCount").textContent = logs.length; }

    function createLogLi(log, index) {
      const li = document.createElement("li");
      li.dataset.index = index;

      const checkbox = document.createElement("input");
      checkbox.type = "checkbox";
      checkbox.className = "log-checkbox";
      checkbox.addEventListener("change", syncSelectAllButtonLabel);

      const textSpan = document.createElement("span");
      textSpan.className = "log-text";
      textSpan.textContent = formatLogText(log);

      li.appendChild(checkbox);
      li.appendChild(textSpan);
      return li;
    }

    function renderLogs() {
      const logList = document.getElementById("logList");
      logList.innerHTML = "";
      logs.forEach((log, idx) => logList.appendChild(createLogLi(log, idx)));
      updateLogCount();
      syncSelectAllButtonLabel();
    }

    function appendLog(label, coord) {
      const now = new Date();
      const timeStr = now.toLocaleString();
      logs.unshift({ time: timeStr, label, coord });
      saveLogs();
      renderLogs();
      showBackupWarningIfNeeded();
    }

    function getSelectedLogItems() {
      const items = Array.from(document.querySelectorAll("#logList li"));
      return items.filter(li => (li.querySelector(".log-checkbox") || {}).checked);
    }

    function syncSelectAllButtonLabel(){
      const btn = document.getElementById("btnSelectAllLog");
      const cbs = Array.from(document.querySelectorAll("#logList .log-checkbox"));
      if (cbs.length === 0) { btn.textContent = "전체 선택"; return; }
      const allChecked = cbs.every(cb => cb.checked);
      btn.textContent = allChecked ? "전체 해제" : "전체 선택";
    }

    function toggleSelectAllLogs() {
      const checkboxes = Array.from(document.querySelectorAll("#logList .log-checkbox"));
      if (checkboxes.length === 0) return;
      const allChecked = checkboxes.every(cb => cb.checked);
      const next = !allChecked;
      checkboxes.forEach(cb => cb.checked = next);
      syncSelectAllButtonLabel();
    }

    function deleteSelectedLogs() {
      const selected = getSelectedLogItems();
      if (selected.length === 0) return alert("삭제할 기록을 선택하세요.");
      if (!confirm(selected.length + "개의 기록을 삭제할까요?")) return;

      const indexes = selected
        .map(li => Number(li.dataset.index))
        .filter(n => !Number.isNaN(n))
        .sort((a, b) => b - a);

      indexes.forEach(idx => { if (idx >= 0 && idx < logs.length) logs.splice(idx, 1); });
      saveLogs();
      renderLogs();
    }

    function editSelectedLog() {
      const selected = getSelectedLogItems();
      if (selected.length === 0) return alert("수정할 기록을 선택하세요.");
      if (selected.length > 1) return alert("한 번에 하나의 기록만 수정할 수 있습니다.");

      const idx = Number(selected[0].dataset.index);
      if (Number.isNaN(idx) || idx < 0 || idx >= logs.length) return alert("로그 인덱스 오류입니다.");

      const old = logs[idx];
      const newLabel = prompt("새 내용(두 번째 줄)을 입력하세요:", old.label);
      if (!newLabel || newLabel.trim() === "") return;

      logs[idx].label = newLabel.trim();
      saveLogs();
      renderLogs();
    }

    function fallbackCopyText(text, count, label) {
      const textarea = document.createElement("textarea");
      textarea.value = text;
      textarea.style.position = "fixed";
      textarea.style.top = "-9999px";
      document.body.appendChild(textarea);
      textarea.select();
      try {
        document.execCommand("copy");
        alert(label + " 기록이 클립보드에 복사되었습니다. (" + count + "개)");
      } catch (e) {
        alert("복사 중 오류가 발생했습니다. 직접 선택해서 복사해 주세요.");
      }
      document.body.removeChild(textarea);
    }

    function copyTextWithClipboard(text, count, label) {
      if (navigator.clipboard && navigator.clipboard.writeText) {
        navigator.clipboard.writeText(text)
          .then(() => alert(label + " 기록이 클립보드에 복사되었습니다. (" + count + "개)"))
          .catch(() => fallbackCopyText(text, count, label));
      } else {
        fallbackCopyText(text, count, label);
      }
    }

    function copyAllLogs() {
      if (logs.length === 0) return alert("복사할 기록이 없습니다.");
      const lines = logs.map(formatLogText);
      copyTextWithClipboard(lines.join("\n\n"), lines.length, "전체");
    }

    function copySelectedLogs() {
      const selected = getSelectedLogItems();
      if (selected.length === 0) return alert("복사할 기록을 선택하세요.");

      const indexes = selected
        .map(li => Number(li.dataset.index))
        .filter(n => !Number.isNaN(n))
        .sort((a, b) => a - b);

      const lines = indexes.map(idx => formatLogText(logs[idx]));
      copyTextWithClipboard(lines.join("\n\n"), lines.length, "선택한");
    }

    function updateBreadcrumb() {
      const bc = document.getElementById("breadcrumb");
      if (currentParentId === "root") return bc.textContent = "위치: ROOT";

      const pathNodes = [];
      function dfs(node, targetId, path) {
        path.push(node);
        if (node.id === targetId) return true;
        const children = node.children || [];
        for (let i = 0; i < children.length; i++) if (dfs(children[i], targetId, path)) return true;
        path.pop();
        return false;
      }
      dfs(tree, currentParentId, pathNodes);
      bc.textContent = "위치: " + pathNodes.map(n => n.label).join(" > ");
    }

    function renderButtons() {
      const container = document.getElementById("buttonContainer");
      container.innerHTML = "";

      const parentNode = getCurrentParentNode();
      const children = parentNode.children || [];

      let parentDepth = getDepthById(tree, parentNode.id, 0);
      if (parentDepth < 0) parentDepth = 0;
      const childDepth = parentDepth + 1;
      const colLetters = columnIndexToLetters(childDepth);

      if (children.length === 0) {
        const div = document.createElement("div");
        div.className = "empty-text";
        div.textContent = "이 위치에는 버튼이 없습니다. 아래에서 +새버튼으로 추가하세요.";
        container.appendChild(div);
        return;
      }

      children.forEach((child, index) => {
        const row = document.createElement("div");
        row.className = "btn-row";

        const rowNumber = index + 1;
        const coord = colLetters + rowNumber;

        // ✅ 커서: 다중 체크 가능(체크리스트)
        const checkWrap = document.createElement("div");
        checkWrap.className = "row-check";
        const chk = document.createElement("input");
        chk.type = "checkbox";
        chk.className = "btn-checklist";
        chk.dataset.id = child.id;
        chk.addEventListener("change", () => {
          // 마지막으로 체크한 버튼 기억(하위 추가 대상 표시용으로 활용 가능)
          if (chk.checked) lastCheckedButtonId = child.id;
          else if (lastCheckedButtonId === child.id) lastCheckedButtonId = null;
        });
        checkWrap.appendChild(chk);

        // ✅ 버튼 클릭: 입력X, 하위가 있으면 이동(없으면 아무 동작 안 함)
        const mainBtn = document.createElement("button");
        mainBtn.className = "btn-main";
        mainBtn.textContent = "[" + coord + "] " + child.label;

        mainBtn.addEventListener("click", () => {
          if (child.children && child.children.length > 0) {
            currentParentId = child.id;
            render();
          } else {
            // 아무 것도 하지 않음(요청사항)
          }
        });

        // ✅ 컨트롤: 입력/이름/삭제/↑↓
        const controls = document.createElement("div");
        controls.className = "btn-controls";

        const insertBtn = document.createElement("button");
        insertBtn.className = "btn-insert";
        insertBtn.textContent = "입력";
        insertBtn.title = "클릭 기록에 입력";
        insertBtn.addEventListener("click", () => {
          appendLog(child.label, coord);
        });

        const renameBtn = document.createElement("button");
        renameBtn.textContent = "이름";
        renameBtn.addEventListener("click", () => {
          const newName = prompt("새 버튼 이름을 입력하세요:", child.label);
          if (newName && newName.trim() !== "") {
            child.label = newName.trim();
            saveTree();
            render();
          }
        });

        const delBtn = document.createElement("button");
        delBtn.textContent = "삭제";
        delBtn.addEventListener("click", () => {
          if (!confirm("'" + child.label + "' 버튼을 삭제할까요? (하위 버튼도 함께 삭제됩니다)")) return;
          parentNode.children.splice(index, 1);
          saveTree();
          render();
        });

        const upBtn = document.createElement("button");
        upBtn.textContent = "↑";
        upBtn.title = "위로";
        upBtn.addEventListener("click", () => moveSibling(parentNode, index, -1));

        const downBtn = document.createElement("button");
        downBtn.textContent = "↓";
        downBtn.title = "아래로";
        downBtn.addEventListener("click", () => moveSibling(parentNode, index, 1));

        controls.appendChild(insertBtn);
        controls.appendChild(renameBtn);
        controls.appendChild(delBtn);
        controls.appendChild(upBtn);
        controls.appendChild(downBtn);

        row.appendChild(checkWrap);
        row.appendChild(mainBtn);
        row.appendChild(controls);
        container.appendChild(row);
      });
    }

    function render() {
      if (currentParentId !== "root" && !findNodeById(tree, currentParentId)) currentParentId = "root";
      updateBreadcrumb();
      renderPathChips();
      renderButtons();
      updateLogCount();
      applyUI();
    }

    function openStats(){
      const count = logs.length;
      const chars = logs.reduce((acc, l) => acc + (String(l.label || "").length), 0);
      const totalBtns = countAllButtons(tree);
      const hereBtns = (getCurrentParentNode().children || []).length;

      document.getElementById("statCount").textContent = String(count);
      document.getElementById("statChars").textContent = String(chars);
      document.getElementById("statBtns").textContent = String(totalBtns);
      document.getElementById("statHereBtns").textContent = String(hereBtns);

      document.getElementById("statsBackdrop").style.display = "flex";
    }
    function closeStats(){ document.getElementById("statsBackdrop").style.display = "none"; }

    // 직접 입력: Enter=기록, Shift+Enter=줄바꿈
    function writeManualLogFromInput() {
      const input = document.getElementById("quickAddInput");
      const text = (input?.value || "").trimEnd();
      if (!text.trim()) return;
      appendLog(text, "입력");
      input.value = "";
      input.focus();
    }

    // ✅ 초기 로드
    loadTreeLocal();
    loadLogsLocal();
    loadUILocal();
    render();
    showBackupWarningIfNeeded();

    // 네비
    document.getElementById("btnUp").addEventListener("click", () => {
      if (currentParentId === "root") return;
      const parentId = findParentId(tree, currentParentId, null);
      currentParentId = parentId || "root";
      render();
    });
    document.getElementById("btnRoot").addEventListener("click", () => {
      currentParentId = "root";
      render();
    });

    // +새버튼: 현재 위치에 추가
    document.getElementById("btnAddHere").addEventListener("click", () => {
      const parentNode = getCurrentParentNode();
      const name = prompt("새 버튼 이름을 입력하세요:");
      if (name && name.trim() !== "") {
        if (!parentNode.children) parentNode.children = [];
        parentNode.children.push({ id: genId(), label: name.trim(), children: [] });
        saveTree();
        render();
      }
    });

    // ✅ +하위버튼: "현재 위치"에 속하는 하위 버튼을 추가
    // 사용 흐름: 버튼 클릭해서 들어간 뒤(+상단 위치가 바뀜) -> +하위버튼 누르면 그 위치에 추가
    document.getElementById("btnAddChild").addEventListener("click", () => {
      // currentParentId가 root이면 root의 하위로 추가(=최상위 추가)
      const parentNode = getCurrentParentNode();
      const childName = prompt(`'${parentNode.id === "root" ? "전체(ROOT)" : parentNode.label}'의 하위 버튼 이름을 입력하세요:`);
      if (!childName || !childName.trim()) return;

      if (!parentNode.children) parentNode.children = [];
      parentNode.children.push({ id: genId(), label: childName.trim(), children: [] });

      saveTree();
      render();
    });

    // 직접 입력
    document.getElementById("btnQuickAdd").addEventListener("click", writeManualLogFromInput);
    document.getElementById("quickAddInput").addEventListener("keydown", (e) => {
      if (e.key === "Enter") {
        if (e.shiftKey) return;
        e.preventDefault();
        writeManualLogFromInput();
      }
    });

    // 로그 액션
    document.getElementById("btnSelectAllLog").addEventListener("click", toggleSelectAllLogs);
    document.getElementById("btnDeleteLog").addEventListener("click", deleteSelectedLogs);
    document.getElementById("btnEditLog").addEventListener("click", editSelectedLog);
    document.getElementById("btnCopyAllLog").addEventListener("click", copyAllLogs);
    document.getElementById("btnCopySelectedLog").addEventListener("click", copySelectedLogs);

    // 디자인모드
    document.getElementById("btnDesignMode").addEventListener("click", () => {
      ui.designMode = !ui.designMode;
      applyUI();
      saveUILocal();
      scheduleCloudSave();
    });
    document.getElementById("rangeBtnWidth").addEventListener("input", (e) => {
      ui.btnWidthPct = Number(e.target.value || 39);
      applyUI(); saveUILocal(); scheduleCloudSave();
    });
    document.getElementById("rangeManualW").addEventListener("input", (e) => {
      ui.manualWidthPct = Number(e.target.value || 70);
      applyUI(); saveUILocal(); scheduleCloudSave();
    });

    // 통계모드
    document.getElementById("btnStatsMode").addEventListener("click", openStats);
    document.getElementById("btnStatsClose").addEventListener("click", closeStats);
    document.getElementById("statsBackdrop").addEventListener("click", (e) => {
      if (e.target.id === "statsBackdrop") closeStats();
    });

    // 로그인
    document.getElementById("btnLogin").addEventListener("click", async () => {
      try { await auth.signInWithPopup(provider); }
      catch (e) {
        console.error(e);
        alert("로그인 실패: 팝업 차단 또는 Firebase 도메인 설정 문제일 수 있어요.\n\nF12 콘솔의 에러코드(auth/...)를 확인해 주세요.");
      }
    });
    document.getElementById("btnLogout").addEventListener("click", async () => {
      try { await auth.signOut(); } catch (e) { console.error(e); }
    });

    auth.onAuthStateChanged(async (user) => {
      currentUser = user || null;
      setAuthUI();

      if (!currentUser) {
        if (unsubscribeDoc) unsubscribeDoc();
        unsubscribeDoc = null;
        return;
      }

      try {
        await cloudFirstInit(currentUser.uid);
        startRealtimeListener(currentUser.uid);
        scheduleCloudSave();
      } catch (e) {
        console.error(e);
        alert("클라우드 동기화 중 오류가 발생했습니다. (F12 콘솔 확인)");
      }
    });

    setAuthUI();
  </script>
</body>
</html>
