<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>ë²„íŠ¼ íŠ¸ë¦¬ ê¸°ë¡ ì•±</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    * { box-sizing: border-box; font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif; }
    body { margin: 0; padding: 10px; background: #f5f5f5; }
    .app {
      max-width: 900px; margin: 0 auto; background: #ffffff; border-radius: 12px;
      padding: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    }
    h1 { margin: 0 0 8px; font-size: 18px; display:flex; align-items:center; justify-content:space-between; gap:8px; flex-wrap:wrap;}
    .badge { font-size:12px; border:1px solid #ddd; border-radius:999px; padding:4px 10px; background:#fafafa; }
    .auth-bar { display:flex; gap:6px; align-items:center; flex-wrap:wrap; margin-bottom:8px; }
    .auth-status { font-size:12px; opacity:.85; }
    .note { font-size:12px; opacity:.75; margin:6px 0 0; }

    .top-bar { display: flex; flex-wrap: wrap; gap: 6px; align-items: center; margin-bottom: 8px; }
    .top-bar small { opacity: 0.8; }

    button { cursor: pointer; border-radius: 8px; border: 1px solid #ddd; background: #fff; padding: 6px 10px; font-size: 13px; }
    button:active { transform: scale(0.97); }
    button:disabled { opacity: .5; cursor: not-allowed; }

    .btn-main {
      flex: 1; text-align: left; padding: 10px; border-radius: 10px;
      border: 1px solid #ccc; background: #fafafa; font-size: 14px; min-height: 40px;
    }
    .btn-row { display: flex; align-items: center; gap: 4px; margin-bottom: 6px; }
    .btn-controls { display: flex; gap: 2px; }
    .btn-controls button { padding: 4px 6px; font-size: 11px; }

    .buttons-area { margin-top: 6px; margin-bottom: 10px; max-height: 55vh; overflow-y: auto; padding-right: 4px; }
    .add-current { margin: 4px 0 10px; width: 100%; background: #eef7ff; border-color: #b3d4ff; }

    .layout { display: flex; flex-direction: column; gap: 10px; }
    @media (min-width: 720px) { .layout { flex-direction: row; } }
    .left, .right { flex: 1; min-width: 0; }
    .panel-title { font-size: 14px; margin-bottom: 4px; font-weight: 600; }

    .log-header { display: flex; align-items: baseline; gap: 6px; margin-bottom: 4px; flex-wrap: wrap; }
    .log-count { font-size: 12px; opacity: 0.7; }
    .log-actions { margin-left: auto; display: flex; gap: 4px; flex-wrap: wrap; }

    .log-box { background: #fafafa; border-radius: 10px; border: 1px solid #ddd; padding: 8px; max-height: 60vh; overflow-y: auto; }
    #logList { list-style: none; padding: 0; margin: 0; font-size: 12px; }
    #logList li {
      padding: 4px 2px; border-bottom: 1px solid #eee; word-break: break-all;
      display: flex; align-items: center; gap: 4px;
    }
    #logList li:last-child { border-bottom: none; }
    .log-text { flex: 1; }
    .log-checkbox { flex-shrink: 0; }
    .empty-text { font-size: 12px; opacity: 0.6; }
  </style>
</head>
<body>
  <div class="app">
    <h1>
      ë²„íŠ¼ íŠ¸ë¦¬ ê¸°ë¡ ì•±
      <span class="badge" id="syncBadge">ë¡œì»¬ ëª¨ë“œ</span>
    </h1>

    <div class="auth-bar">
      <button id="btnLogin">Google ë¡œê·¸ì¸</button>
      <button id="btnLogout" disabled>ë¡œê·¸ì•„ì›ƒ</button>
      <span class="auth-status" id="authStatus">ë¡œê·¸ì¸ ì•ˆ ë¨</span>
    </div>
    <div class="note">â€» ë¡œê·¸ì¸í•˜ë©´ <b>í•­ìƒ í´ë¼ìš°ë“œ ë°ì´í„°ê°€ ìš°ì„ </b> ì ìš©ë©ë‹ˆë‹¤. (ë¡œì»¬ì€ ìë™ìœ¼ë¡œ í´ë¼ìš°ë“œë¡œ ë§ì¶°ì§)</div>

    <div class="top-bar">
      <button id="btnUp">â—€ ìƒìœ„ë¡œ</button>
      <button id="btnRoot">â¬† ìµœìƒìœ„ë¡œ</button>
      <small id="breadcrumb">ìœ„ì¹˜: ROOT</small>
    </div>

    <div class="layout">
      <div class="left">
        <div class="panel-title">ë²„íŠ¼ ëª©ë¡</div>
        <div class="buttons-area" id="buttonContainer"></div>
        <button class="add-current" id="btnAddHere">+ ì´ ìœ„ì¹˜ì— ìƒˆ ë²„íŠ¼ ì¶”ê°€</button>
        <div class="empty-text">
          ğŸ’¡ í•˜ìœ„ ë²„íŠ¼ì´ ì—†ëŠ” ë²„íŠ¼ì„ ëˆ„ë¥´ë©´ ì˜¤ë¥¸ìª½ì— ê¸°ë¡ë©ë‹ˆë‹¤.<br />
          [A1], [B2] ê°™ì€ í‘œì‹œëŠ” ì—‘ì…€ì˜ ì—´(A,B,...)ê³¼ í–‰(1,2,...)ì„ ì˜ë¯¸í•©ë‹ˆë‹¤.
        </div>
      </div>

      <div class="right">
        <div class="log-header">
          <div class="panel-title">í´ë¦­ ê¸°ë¡</div>
          <div class="log-count">(ì´ <span id="logCount">0</span>ê°œ)</div>
          <div class="log-actions">
            <button id="btnDeleteAllLog" style="font-size:11px;padding:4px 6px;">ì „ì²´ ì‚­ì œ</button>
            <button id="btnCopyAllLog" style="font-size:11px;padding:4px 6px;">ì „ì²´ ë³µì‚¬</button>
            <button id="btnCopySelectedLog" style="font-size:11px;padding:4px 6px;">ì„ íƒ ë³µì‚¬</button>
            <button id="btnEditLog" style="font-size:11px;padding:4px 6px;">ì„ íƒ ìˆ˜ì •</button>
            <button id="btnDeleteLog" style="font-size:11px;padding:4px 6px;">ì„ íƒ ì‚­ì œ</button>
          </div>
        </div>
        <div class="log-box">
          <ul id="logList"></ul>
        </div>
      </div>
    </div>
  </div>

  <!-- Firebase (compat) -->
  <script src="https://www.gstatic.com/firebasejs/10.12.5/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.5/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore-compat.js"></script>

  <script>
    /***********************
     * Firebase ì„¤ì • (ë„¤ í”„ë¡œì íŠ¸ ê°’)
     ***********************/
    const firebaseConfig = {
      apiKey: "AIzaSyC8kLsUhGLu4eGhTYlKlh-tKCQkKjF0EvU",
      authDomain: "button-tree.firebaseapp.com",
      projectId: "button-tree",
      storageBucket: "button-tree.firebasestorage.app",
      messagingSenderId: "670872655484",
      appId: "1:670872655484:web:a8f5a5201cd845a4075bf9",
      measurementId: "G-9P3ZV8LLQ3"
    };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();
    const provider = new firebase.auth.GoogleAuthProvider();

    /***********************
     * ë¡œì»¬ í‚¤
     ***********************/
    const TREE_STORAGE_KEY = "buttonTree_v_local";
    const LOG_STORAGE_KEY  = "buttonLogs_v1";

    /***********************
     * ë°±ì—… ê²½ê³ (í•­ìƒ ë„ìš°ê¸°)
     ***********************/
    const BACKUP_WARN_THRESHOLD = 1000;

    function showBackupWarningIfNeeded() {
      if (!Array.isArray(logs)) return;
      if (logs.length < BACKUP_WARN_THRESHOLD) return;

      alert(
        "âš  í´ë¦­ ê¸°ë¡ì´ 1,000ê°œ ì´ìƒì…ë‹ˆë‹¤.\n\n" +
        "ë°ì´í„° ì†ì‹¤ ìœ„í—˜ì´ ìˆìŠµë‹ˆë‹¤.\n" +
        "'ì „ì²´ ë³µì‚¬'ë¡œ ì£¼ê¸°ì ìœ¼ë¡œ ë°±ì—…í•˜ì„¸ìš”."
      );
    }

    /***********************
     * ìƒíƒœ
     ***********************/
    let tree = null;
    let currentParentId = "root";
    let logs = [];

    let currentUser = null;
    let unsubscribeDoc = null;

    // ì›ê²© ì ìš© ì¤‘ì—ëŠ” save íŠ¸ë¦¬ê±° ë°©ì§€
    let isApplyingRemote = false;

    // ì €ì¥ debounce
    let saveTimer = null;

    /***********************
     * ìœ í‹¸
     ***********************/
    function genId() {
      return "id_" + Date.now().toString(36) + "_" + Math.random().toString(36).slice(2, 8);
    }
    function nowMs() { return Date.now(); }

    function setAuthUI() {
      const status = document.getElementById("authStatus");
      const btnLogin = document.getElementById("btnLogin");
      const btnLogout = document.getElementById("btnLogout");
      const badge = document.getElementById("syncBadge");

      if (currentUser) {
        const name = currentUser.displayName || currentUser.email || "ì‚¬ìš©ì";
        status.textContent = `ë¡œê·¸ì¸ë¨: ${name}`;
        btnLogin.disabled = true;
        btnLogout.disabled = false;
        badge.textContent = "í´ë¼ìš°ë“œ ë™ê¸°í™”";
      } else {
        status.textContent = "ë¡œê·¸ì¸ ì•ˆ ë¨";
        btnLogin.disabled = false;
        btnLogout.disabled = true;
        badge.textContent = "ë¡œì»¬ ëª¨ë“œ";
      }
    }

    function userDocRef(uid) {
      return db.collection("users").doc(uid);
    }

    /***********************
     * ë¡œì»¬ ì €ì¥/ë¶ˆëŸ¬ì˜¤ê¸°
     ***********************/
    function saveTreeLocal() {
      try { localStorage.setItem(TREE_STORAGE_KEY, JSON.stringify(tree)); }
      catch (e) { console.warn("localStorage íŠ¸ë¦¬ ì €ì¥ ì˜¤ë¥˜:", e); }
    }
    function saveLogsLocal() {
      try { localStorage.setItem(LOG_STORAGE_KEY, JSON.stringify(logs)); }
      catch (e) { console.warn("localStorage ë¡œê·¸ ì €ì¥ ì˜¤ë¥˜:", e); }
    }

    function loadTreeLocal() {
      let saved = null;
      try { saved = localStorage.getItem(TREE_STORAGE_KEY); } catch {}
      if (saved) {
        try {
          const parsed = JSON.parse(saved);
          if (parsed && parsed.id && Array.isArray(parsed.children)) { tree = parsed; return; }
        } catch {}
      }
      tree = {
        id: "root",
        label: "
