<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>ë³µí•œì•„ë¦„ ê¸°ë¡ê³µì±…</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    * { box-sizing: border-box; font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif; }
    body { margin: 0; padding: 10px; background: #f5f5f5; }
    .app {
      max-width: 900px; margin: 0 auto; background: #ffffff; border-radius: 12px;
      padding: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    }
    h1 { margin: 0 0 8px; font-size: 18px; display:flex; align-items:center; justify-content:space-between; gap:8px; flex-wrap:wrap;}
    .badge { font-size:12px; border:1px solid #ddd; border-radius:999px; padding:4px 10px; background:#fafafa; }

    .auth-bar { display:flex; gap:6px; align-items:center; flex-wrap:wrap; margin-bottom:8px; }
    .auth-status { font-size:12px; opacity:.85; }
    .note { font-size:12px; opacity:.75; margin:6px 0 0; }

    button { cursor: pointer; border-radius: 8px; border: 1px solid #ddd; background: #fff; padding: 6px 10px; font-size: 13px; }
    button:active { transform: scale(0.97); }
    button:disabled { opacity: .5; cursor: not-allowed; }

    .btn-main {
      flex: 1; text-align: left; padding: 10px; border-radius: 10px;
      border: 1px solid #ccc; background: #fafafa; font-size: 14px; min-height: 40px;
    }
    .btn-row { display: flex; align-items: center; gap: 4px; margin-bottom: 6px; }
    .btn-controls { display: flex; gap: 2px; }
    .btn-controls button { padding: 4px 6px; font-size: 11px; }

    .buttons-area { margin-top: 6px; margin-bottom: 10px; max-height: 55vh; overflow-y: auto; padding-right: 4px; }
    .add-current { margin: 4px 0 10px; width: 100%; background: #eef7ff; border-color: #b3d4ff; }

    .layout { display: flex; flex-direction: column; gap: 10px; }
    @media (min-width: 720px) { .layout { flex-direction: row; } }

    .left, .right { flex: 1 1 0; min-width: 0; }
    .panel-title { font-size: 14px; font-weight: 600; }

    .panel-header-row{
      display:flex;
      align-items:center;
      justify-content:flex-start;
      gap:8px;
      flex-wrap:wrap;
      margin-bottom: 4px;
    }
    .nav-mini{
      display:flex;
      gap:6px;
      flex-wrap:wrap;
      align-items:center;
      margin-left: 6px;
    }
    .nav-mini button{
      padding: 6px 10px;
      font-size: 13px;
      border-radius: 10px;
    }

    .log-header { display: flex; align-items: baseline; gap: 6px; margin-bottom: 4px; flex-wrap: wrap; }
    .log-count { font-size: 12px; opacity: 0.7; }
    .log-actions { margin-left: auto; display: flex; gap: 4px; flex-wrap: wrap; }

    .log-box { background: #fafafa; border-radius: 10px; border: 1px solid #ddd; padding: 8px; max-height: 60vh; overflow-y: auto; }
    #logList { list-style: none; padding: 0; margin: 0; font-size: 12px; }
    #logList li {
      padding: 4px 2px; border-bottom: 1px solid #eee; word-break: break-all;
      display: flex; align-items: center; gap: 4px;
    }
    #logList li:last-child { border-bottom: none; }
    .log-text { flex: 1; }
    .log-checkbox { flex-shrink: 0; }

    .empty-text { font-size: 12px; opacity: 0.75; line-height: 1.45; white-space: pre-wrap; }
    .help-edit-btn { margin-top: 6px; width: 100%; font-size: 12px; padding: 6px 10px; }
    .help-box {
      border: 1px dashed #ddd; border-radius: 10px; padding: 10px; background: #fbfbfb;
      margin-top: 10px;
      width: 100%;
    }

    .moved-area {
      margin-top: 10px;
      border: 1px solid #eee;
      border-radius: 10px;
      padding: 10px;
      background: #fafafa;
    }
    .breadcrumb-line{
      font-size: 12px;
      opacity: .8;
      margin-top: 6px;
      word-break: break-word;
    }

    .modal-backdrop {
      position: fixed; inset: 0; background: rgba(0,0,0,0.35);
      display: none; align-items: center; justify-content: center; padding: 16px;
      z-index: 9999;
    }
    .modal {
      width: min(720px, 100%);
      background: #fff; border-radius: 12px; border: 1px solid #ddd;
      box-shadow: 0 10px 30px rgba(0,0,0,0.18);
      padding: 12px;
    }
    .modal h2 { font-size: 14px; margin: 0 0 8px; }
    .modal textarea {
      width: 100%; min-height: 180px; resize: vertical;
      border: 1px solid #ddd; border-radius: 10px; padding: 10px; font-size: 13px;
      outline: none;
    }
    .modal-actions { display: flex; gap: 6px; justify-content: flex-end; margin-top: 10px; flex-wrap: wrap; }
    .btn-primary { background: #eef7ff; border-color: #b3d4ff; }

    .todo-box{
      border: 1px solid #ddd;
      border-radius: 10px;
      padding: 10px;
      background: #fafafa;
      margin-top: 8px;
      width: 100%;
    }
    .todo-sub {
      font-size: 12px;
      opacity: .7;
      margin-top: 4px;
      line-height: 1.35;
    }
    .todo-table {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 2px;
      margin-top: 8px;
    }
    .todo-cell { border: 1px solid #ccc; background: #fff; }
    .todo-cell.header {
      background: #eef7ff;
      font-weight: 700;
      text-align: center;
      padding: 8px 6px;
      font-size: 12px;
    }
    .todo-cell input {
      width: 100%;
      height: 34px;
      border: none;
      padding: 4px 6px;
      font-size: 12px;
      outline: none;
      background: transparent;
      text-align: center;
    }
    .todo-cell input:focus {
      background: #f0f8ff;
      box-shadow: inset 0 0 0 2px rgba(179, 212, 255, .35);
    }

    /* âœ… ì •ì‹ ë ¥ ì ìˆ˜ */
    .mind-box{
      border: 1px solid #ddd;
      border-radius: 10px;
      padding: 10px;
      background: #fafafa;
      margin-bottom: 10px; /* âœ… ë§¨ ìœ„ë¡œ ì™”ìœ¼ë‹ˆ ì•„ë˜ ì—¬ë°± */
    }
    .mind-row{
      display:flex;
      gap:6px;
      align-items:center;
      flex-wrap:wrap;
      margin-top: 6px;
    }
    .mind-row input{
      flex: 1 1 160px;
      height: 34px;
      border: 1px solid #ccc;
      border-radius: 10px;
      padding: 6px 10px;
      font-size: 13px;
      outline: none;
      background: #fff;
    }
    .mind-row input:focus{
      box-shadow: inset 0 0 0 2px rgba(179, 212, 255, .35);
      border-color: #b3d4ff;
    }
    .mind-hint{
      font-size: 12px;
      opacity: .7;
      margin-top: 4px;
      line-height: 1.35;
    }
    .minus-btn.on{
      background:#111;
      color:#fff;
      border-color:#111;
    }
  </style>
</head>
<body>
  <div class="app">
    <h1>
      ë³µí•œì•„ë¦„ ê¸°ë¡ê³µì±…
      <span class="badge" id="syncBadge">ë¡œì»¬ ëª¨ë“œ</span>
    </h1>

    <div class="layout">
      <!-- âœ… LEFT: ì •ì‹ ë ¥ ì ìˆ˜(ë§¨ ìœ„) â†’ ë²„íŠ¼ëª©ë¡(ê·¸ ë°‘) -->
      <div class="left">

        <!-- âœ… ì •ì‹ ë ¥ ì ìˆ˜: ë§¨ ìœ„ë¡œ ì´ë™ -->
        <div class="mind-box">
          <div class="panel-title">ì •ì‹ ë ¥ ì ìˆ˜</div>
          <div class="mind-hint">ì ìˆ˜ ì…ë ¥ í›„ Enter ë˜ëŠ” â€œê¸°ë¡â€ì„ ëˆ„ë¥´ë©´ í´ë¦­ ê¸°ë¡ì— ì €ì¥ë©ë‹ˆë‹¤. (í—ˆìš©ë²”ìœ„: 0~100 / -100~0)</div>
          <div class="mind-row">
            <button id="btnMinus" class="minus-btn" title="ë§ˆì´ë„ˆìŠ¤ í† ê¸€">-</button>
            <input id="mindScoreInput" inputmode="numeric" placeholder="ì˜ˆ: 87" />
            <button id="btnMindRecord" class="btn-primary">ê¸°ë¡</button>
          </div>
        </div>

        <!-- ë²„íŠ¼ ëª©ë¡ -->
        <div class="panel-header-row">
          <div class="panel-title">ë²„íŠ¼ ëª©ë¡</div>
          <div class="nav-mini">
            <button id="btnUp">â—€ ìƒìœ„ë¡œ</button>
            <button id="btnRoot">â¬† ìµœìƒìœ„ë¡œ</button>
          </div>
        </div>

        <div class="buttons-area" id="buttonContainer"></div>
        <button class="add-current" id="btnAddHere">+ ì´ ìœ„ì¹˜ì— ìƒˆ ë²„íŠ¼ ì¶”ê°€</button>

        <div class="todo-box">
          <div class="panel-title">í•  ì¼ / ì™„ë£Œí•œ ì¼</div>
          <div class="todo-sub">Enter: ì•„ë˜ì¹¸ ì´ë™ Â· ë°©í–¥í‚¤: ì…€ ì´ë™</div>
          <div class="todo-table" id="todoTable"></div>
        </div>

        <div class="moved-area">
          <div class="auth-bar">
            <button id="btnLogin">Google ë¡œê·¸ì¸</button>
            <button id="btnLogout" disabled>ë¡œê·¸ì•„ì›ƒ</button>
            <span class="auth-status" id="authStatus">ë¡œê·¸ì¸ ì•ˆ ë¨</span>
          </div>
          <div class="note">â€» ë¡œê·¸ì¸í•˜ë©´ <b>í•­ìƒ í´ë¼ìš°ë“œ ë°ì´í„°ê°€ ìš°ì„ </b> ì ìš©ë©ë‹ˆë‹¤. (ë¡œì»¬ì€ ìë™ìœ¼ë¡œ í´ë¼ìš°ë“œë¡œ ë§ì¶°ì§)</div>
          <div class="breadcrumb-line" id="breadcrumb">ìœ„ì¹˜: ROOT</div>
        </div>
      </div>

      <!-- âœ… RIGHT: í´ë¦­ê¸°ë¡ + ì•ˆë‚´ë¬¸ -->
      <div class="right">
        <div class="log-header">
          <div class="panel-title">í´ë¦­ ê¸°ë¡</div>
          <div class="log-count">(ì´ <span id="logCount">0</span>ê°œ)</div>
          <div class="log-actions">
            <button id="btnDeleteAllLog" style="font-size:11px;padding:4px 6px;">ì „ì²´ ì‚­ì œ</button>
            <button id="btnCopyAllLog" style="font-size:11px;padding:4px 6px;">ì „ì²´ ë³µì‚¬</button>
            <button id="btnCopySelectedLog" style="font-size:11px;padding:4px 6px;">ì„ íƒ ë³µì‚¬</button>
            <button id="btnEditLog" style="font-size:11px;padding:4px 6px;">ì„ íƒ ìˆ˜ì •</button>
            <button id="btnDeleteLog" style="font-size:11px;padding:4px 6px;">ì„ íƒ ì‚­ì œ</button>
          </div>
        </div>

        <div class="log-box">
          <ul id="logList"></ul>
        </div>

        <div class="help-box">
          <div class="panel-title" style="margin-bottom:6px;">ì•ˆë‚´ë¬¸</div>
          <div class="empty-text" id="helpText"></div>
          <button class="help-edit-btn" id="btnEditHelp">âœï¸ ì•ˆë‚´ë¬¸ ìˆ˜ì •</button>
        </div>
      </div>
    </div>
  </div>

  <div class="modal-backdrop" id="helpModalBackdrop">
    <div class="modal">
      <h2>ì•ˆë‚´ë¬¸ ìˆ˜ì •</h2>
      <textarea id="helpEditor" placeholder="ì—¬ê¸°ì— ì•ˆë‚´ë¬¸ì„ ì…ë ¥í•˜ì„¸ìš”."></textarea>
      <div class="modal-actions">
        <button id="btnHelpCancel">ì·¨ì†Œ</button>
        <button class="btn-primary" id="btnHelpSave">ì €ì¥</button>
      </div>
    </div>
  </div>

  <script src="https://www.gstatic.com/firebasejs/10.12.5/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.5/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore-compat.js"></script>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyC8kLsUhGLu4eGhTYlKlh-tKCQkKjF0EvU",
      authDomain: "button-tree.firebaseapp.com",
      projectId: "button-tree",
      storageBucket: "button-tree.firebasestorage.app",
      messagingSenderId: "670872655484",
      appId: "1:670872655484:web:a8f5a5201cd845a4075bf9",
      measurementId: "G-9P3ZV8LLQ3"
    };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();
    const provider = new firebase.auth.GoogleAuthProvider();

    const TREE_STORAGE_KEY = "buttonTree_v_local";
    const LOG_STORAGE_KEY  = "buttonLogs_v1";
    const HELP_STORAGE_KEY = "buttonHelpText_v1";
    const TODO_STORAGE_KEY = "todoTable_v2";

    const BACKUP_WARN_THRESHOLD = 1000;

    let tree = null;
    let currentParentId = "root";
    let logs = [];
    let helpText = "";

    let todoTableData = Array.from({ length: 10 }, () => ["", ""]);

    let currentUser = null;
    let unsubscribeDoc = null;
    let isApplyingRemote = false;
    let saveTimer = null;

    let mindIsNegative = false;

    function genId() {
      return "id_" + Date.now().toString(36) + "_" + Math.random().toString(36).slice(2, 8);
    }
    function nowMs() { return Date.now(); }

    function showBackupWarningIfNeeded() {
      if (!Array.isArray(logs)) return;
      if (logs.length < BACKUP_WARN_THRESHOLD) return;
      alert(
        "âš  í´ë¦­ ê¸°ë¡ì´ 1,000ê°œ ì´ìƒì…ë‹ˆë‹¤.\n\n" +
        "ë°ì´í„° ì†ì‹¤ ìœ„í—˜ì´ ìˆìŠµë‹ˆë‹¤.\n" +
        "'ì „ì²´ ë³µì‚¬'ë¡œ ì£¼ê¸°ì ìœ¼ë¡œ ë°±ì—…í•˜ì„¸ìš”."
      );
    }

    function setAuthUI() {
      const status = document.getElementById("authStatus");
      const btnLogin = document.getElementById("btnLogin");
      const btnLogout = document.getElementById("btnLogout");
      const badge = document.getElementById("syncBadge");

      if (currentUser) {
        const name = currentUser.displayName || currentUser.email || "ì‚¬ìš©ì";
        status.textContent = `ë¡œê·¸ì¸ë¨: ${name}`;
        btnLogin.disabled = true;
        btnLogout.disabled = false;
        badge.textContent = "í´ë¼ìš°ë“œ ë™ê¸°í™”";
      } else {
        status.textContent = "ë¡œê·¸ì¸ ì•ˆ ë¨";
        btnLogin.disabled = false;
        btnLogout.disabled = true;
        badge.textContent = "ë¡œì»¬ ëª¨ë“œ";
      }
    }
    function userDocRef(uid) { return db.collection("users").doc(uid); }

    const DEFAULT_HELP_TEXT =
`ğŸ’¡ í•˜ìœ„ ë²„íŠ¼ì´ ì—†ëŠ” ë²„íŠ¼ì„ ëˆ„ë¥´ë©´ ì˜¤ë¥¸ìª½ì— ê¸°ë¡ë©ë‹ˆë‹¤.
1000ê°œë§ˆë‹¤ ë°±ì—…ì„ í•©ë‹ˆë‹¤. ë°±ì—…ì„ í•œ ë’¤ì—ëŠ” ê°€ì¥ ë°‘ì— ë²„íŠ¼ì— ë°±ì—…í•œ ìë£Œì˜ ê°œìˆ˜ë¥¼ ì ì–´ë†“ìŠµë‹ˆë‹¤.`;

    function saveHelpLocal() {
      try { localStorage.setItem(HELP_STORAGE_KEY, helpText); }
      catch (e) { console.warn("localStorage ì•ˆë‚´ë¬¸ ì €ì¥ ì˜¤ë¥˜:", e); }
    }
    function loadHelpLocal() {
      let saved = "";
      try { saved = localStorage.getItem(HELP_STORAGE_KEY) || ""; } catch {}
      helpText = (saved && saved.trim() !== "") ? saved : DEFAULT_HELP_TEXT;
      renderHelp();
    }
    function renderHelp() {
      const el = document.getElementById("helpText");
      if (!el) return;
      el.textContent = helpText || "";
    }
    function saveHelp() { saveHelpLocal(); scheduleCloudSave(); renderHelp(); }

    function saveTodoLocal() {
      try { localStorage.setItem(TODO_STORAGE_KEY, JSON.stringify(todoTableData)); }
      catch (e) { console.warn("localStorage í‘œ ì €ì¥ ì˜¤ë¥˜:", e); }
    }
    function loadTodoLocal() {
      let saved = null;
      try { saved = localStorage.getItem(TODO_STORAGE_KEY); } catch {}
      if (saved) {
        try {
          const parsed = JSON.parse(saved);
          if (Array.isArray(parsed) && parsed.length === 10) {
            todoTableData = parsed.map(r => Array.isArray(r) ? [String(r[0] ?? ""), String(r[1] ?? "")] : ["",""]);
          }
        } catch {}
      }
    }
    function saveTodo() { saveTodoLocal(); scheduleCloudSave(); }

    function focusCell(r, c) {
      const el = document.querySelector(`input[data-r="${r}"][data-c="${c}"]`);
      if (!el) return;
      el.focus();
      try { el.setSelectionRange(el.value.length, el.value.length); } catch {}
    }

    function renderTodoTable() {
      const container = document.getElementById("todoTable");
      if (!container) return;
      container.innerHTML = "";

      ["í• ì¼", "ì™„ë£Œí•œ ì¼ì´"].forEach(text => {
        const div = document.createElement("div");
        div.className = "todo-cell header";
        div.textContent = text;
        container.appendChild(div);
      });

      todoTableData.forEach((row, r) => {
        row.forEach((val, c) => {
          const cell = document.createElement("div");
          cell.className = "todo-cell";

          const input = document.createElement("input");
          input.value = val;
          input.dataset.r = String(r);
          input.dataset.c = String(c);

          input.addEventListener("input", () => {
            todoTableData[r][c] = input.value;
            saveTodo();
          });

          input.addEventListener("keydown", (e) => {
            const key = e.key;
            if (key === "Enter") { e.preventDefault(); focusCell(Math.min(9, r + 1), c); return; }
            if (key === "ArrowUp") { e.preventDefault(); focusCell(Math.max(0, r - 1), c); return; }
            if (key === "ArrowDown") { e.preventDefault(); focusCell(Math.min(9, r + 1), c); return; }
            if (key === "ArrowLeft") { e.preventDefault(); focusCell(r, Math.max(0, c - 1)); return; }
            if (key === "ArrowRight") { e.preventDefault(); focusCell(r, Math.min(1, c + 1)); return; }
          });

          cell.appendChild(input);
          container.appendChild(cell);
        });
      });
    }

    function saveTreeLocal() {
      try { localStorage.setItem(TREE_STORAGE_KEY, JSON.stringify(tree)); }
      catch (e) { console.warn("localStorage íŠ¸ë¦¬ ì €ì¥ ì˜¤ë¥˜:", e); }
    }
    function saveLogsLocal() {
      try { localStorage.setItem(LOG_STORAGE_KEY, JSON.stringify(logs)); }
      catch (e) { console.warn("localStorage ë¡œê·¸ ì €ì¥ ì˜¤ë¥˜:", e); }
    }

    function loadTreeLocal() {
      let saved = null;
      try { saved = localStorage.getItem(TREE_STORAGE_KEY); } catch {}
      if (saved) {
        try {
          const parsed = JSON.parse(saved);
          if (parsed && parsed.id && Array.isArray(parsed.children)) { tree = parsed; return; }
        } catch {}
      }
      tree = { id: "root", label: "ROOT", children: [] };
      saveTreeLocal();
    }

    function loadLogsLocal() {
      let saved = null;
      try { saved = localStorage.getItem(LOG_STORAGE_KEY); } catch {}
      if (saved) {
        try {
          const parsed = JSON.parse(saved);
          if (Array.isArray(parsed)) { logs = parsed; renderLogs(); return; }
        } catch {}
      }
      logs = [];
      renderLogs();
    }

    async function cloudLoad(uid) {
      const snap = await userDocRef(uid).get();
      if (!snap.exists) return null;
      return snap.data();
    }

    function scheduleCloudSave() {
      if (!currentUser) return;
      if (isApplyingRemote) return;

      clearTimeout(saveTimer);
      saveTimer = setTimeout(async () => {
        try {
          await userDocRef(currentUser.uid).set({
            tree,
            logs,
            helpText,
            todoTableData,
            updatedAtMs: nowMs(),
            updatedAt: firebase.firestore.FieldValue.serverTimestamp()
          }, { merge: true });
        } catch (e) {
          console.warn("cloud save ì‹¤íŒ¨:", e);
        }
      }, 300);
    }

    async function cloudFirstInit(uid) {
      const remote = await cloudLoad(uid);

      if (remote && (remote.tree || remote.logs || remote.helpText || remote.todoTableData)) {
        applyRemote(remote);
        saveTreeLocal(); saveLogsLocal(); saveHelpLocal(); saveTodoLocal();
        return;
      }

      await userDocRef(uid).set({
        tree, logs, helpText, todoTableData,
        updatedAtMs: nowMs(),
        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
      }, { merge: true });
    }

    function applyRemote(remote) {
      try {
        isApplyingRemote = true;
        const prevParentId = currentParentId;

        if (remote.tree && remote.tree.id && Array.isArray(remote.tree.children)) {
          tree = remote.tree;
          const stillExists = findNodeById(tree, prevParentId);
          currentParentId = stillExists ? prevParentId : "root";
        }
        if (Array.isArray(remote.logs)) logs = remote.logs;
        if (typeof remote.helpText === "string" && remote.helpText.trim() !== "") helpText = remote.helpText;

        if (Array.isArray(remote.todoTableData) && remote.todoTableData.length === 10) {
          todoTableData = remote.todoTableData.map(r => Array.isArray(r) ? [String(r[0] ?? ""), String(r[1] ?? "")] : ["",""]);
        }

        renderLogs(); render(); renderHelp(); renderTodoTable();
        showBackupWarningIfNeeded();
      } finally {
        isApplyingRemote = false;
      }
    }

    function startRealtimeListener(uid) {
      if (unsubscribeDoc) unsubscribeDoc();
      unsubscribeDoc = userDocRef(uid).onSnapshot((snap) => {
        if (!snap.exists) return;
        const remote = snap.data() || {};
        if (isApplyingRemote) return;
        if (!remote.tree && !remote.logs && !remote.helpText && !remote.todoTableData) return;

        applyRemote(remote);
        saveTreeLocal(); saveLogsLocal(); saveHelpLocal(); saveTodoLocal();
      }, (err) => console.warn("onSnapshot ì˜¤ë¥˜:", err));
    }

    function saveTree() { saveTreeLocal(); scheduleCloudSave(); }
    function saveLogs() { saveLogsLocal(); scheduleCloudSave(); }

    function findNodeById(node, id) {
      if (!node) return null;
      if (node.id === id) return node;
      const children = node.children || [];
      for (let i = 0; i < children.length; i++) {
        const found = findNodeById(children[i], id);
        if (found) return found;
      }
      return null;
    }
    function findParentId(root, targetId, parentId) {
      if (root.id === targetId) return parentId;
      const children = root.children || [];
      for (let i = 0; i < children.length; i++) {
        const found = findParentId(children[i], targetId, root.id);
        if (found !== null && found !== undefined) return found;
      }
      return null;
    }
    function getDepthById(node, targetId, depth) {
      if (depth === undefined) depth = 0;
      if (!node) return -1;
      if (node.id === targetId) return depth;
      const children = node.children || [];
      for (let i = 0; i < children.length; i++) {
        const d = getDepthById(children[i], targetId, depth + 1);
        if (d !== -1) return d;
      }
      return -1;
    }
    function columnIndexToLetters(n) {
      if (!n || n <= 0) n = 1;
      let s = "";
      while (n > 0) {
        const rem = (n - 1) % 26;
        s = String.fromCharCode(65 + rem) + s;
        n = Math.floor((n - 1) / 26);
      }
      return s;
    }
    function getCurrentParentNode() {
      const node = findNodeById(tree, currentParentId);
      if (!node) currentParentId = "root";
      return node || tree;
    }
    function moveSibling(parentNode, index, delta) {
      if (!parentNode || !parentNode.children) return;
      const newIndex = index + delta;
      if (newIndex < 0 || newIndex >= parentNode.children.length) return;
      const arr = parentNode.children;
      const tmp = arr[index];
      arr[index] = arr[newIndex];
      arr[newIndex] = tmp;
      saveTree();
      render();
    }

    function updateLogCount() {
      const countSpan = document.getElementById("logCount");
      if (!countSpan) return;
      countSpan.textContent = logs.length;
    }
    function createLogLi(log, index) {
      const li = document.createElement("li");
      li.dataset.index = index;

      const checkbox = document.createElement("input");
      checkbox.type = "checkbox";
      checkbox.className = "log-checkbox";

      const textSpan = document.createElement("span");
      textSpan.className = "log-text";
      textSpan.textContent = `${log.time} - [${log.coord}] ${log.label}`;

      li.appendChild(checkbox);
      li.appendChild(textSpan);
      return li;
    }
    function renderLogs() {
      const logList = document.getElementById("logList");
      if (!logList) return;
      logList.innerHTML = "";
      logs.forEach((log, idx) => logList.appendChild(createLogLi(log, idx)));
      updateLogCount();
    }
    function appendLog(label, coord) {
      const timeStr = new Date().toLocaleString();
      logs.unshift({ time: timeStr, label, coord });
      saveLogs();
      renderLogs();
      showBackupWarningIfNeeded();
    }

    function sanitizeMindInput() {
      const input = document.getElementById("mindScoreInput");
      if (!input) return;
      let v = (input.value || "").trim();
      v = v.replace(/[^\d]/g, "");
      input.value = v;
    }

    function setMindNegative(on) {
      mindIsNegative = !!on;
      const btn = document.getElementById("btnMinus");
      const input = document.getElementById("mindScoreInput");
      if (btn) btn.classList.toggle("on", mindIsNegative);
      if (input) {
        input.placeholder = mindIsNegative ? "ì˜ˆ: 50  (ê¸°ë¡: -50)" : "ì˜ˆ: 87";
        input.focus();
      }
    }
    function toggleMindNegative() { setMindNegative(!mindIsNegative); }

    function parseAndValidateMindScore({ showAlert }) {
      const input = document.getElementById("mindScoreInput");
      if (!input) return { ok:false, score: null };

      sanitizeMindInput();
      const rawDigits = (input.value || "").trim();
      if (!rawDigits) {
        if (showAlert) alert("ì •ì‹ ë ¥ ì ìˆ˜ë¥¼ ì…ë ¥í•˜ì„¸ìš”.");
        return { ok:false, score: null };
      }

      const absVal = Number(rawDigits);
      if (!Number.isFinite(absVal)) {
        if (showAlert) alert("ìˆ«ìë¡œ ì…ë ¥í•´ ì£¼ì„¸ìš”. ì˜ˆ: 87");
        return { ok:false, score: null };
      }

      if (absVal < 0 || absVal > 100) {
        if (showAlert) alert("ì ìˆ˜ëŠ” 0~100 ì‚¬ì´ë§Œ ì…ë ¥í•  ìˆ˜ ìˆì–´ìš”.");
        return { ok:false, score: null };
      }

      const score = mindIsNegative ? -absVal : absVal;

      if (!mindIsNegative && (score < 0 || score > 100)) {
        if (showAlert) alert("ì ìˆ˜ëŠ” 0~100 ì‚¬ì´ë§Œ ê¸°ë¡í•  ìˆ˜ ìˆì–´ìš”.");
        return { ok:false, score: null };
      }
      if (mindIsNegative && (score < -100 || score > 0)) {
        if (showAlert) alert("ë§ˆì´ë„ˆìŠ¤ ì ìˆ˜ëŠ” -100~0 ì‚¬ì´ë§Œ ê¸°ë¡í•  ìˆ˜ ìˆì–´ìš”.");
        return { ok:false, score: null };
      }

      return { ok:true, score };
    }

    function recordMindScore() {
      const input = document.getElementById("mindScoreInput");
      if (!input) return;

      const { ok, score } = parseAndValidateMindScore({ showAlert: true });
      if (!ok) return;

      appendLog(`ì •ì‹ ë ¥: ${score}ì `, "MIND");
      input.value = "";
      input.focus();
    }

    function getSelectedLogItems() {
      const logList = document.getElementById("logList");
      if (!logList) return [];
      const items = Array.from(logList.querySelectorAll("li"));
      return items.filter(li => li.querySelector(".log-checkbox")?.checked);
    }
    function deleteSelectedLogs() {
      const selected = getSelectedLogItems();
      if (selected.length === 0) return alert("ì‚­ì œí•  ê¸°ë¡ì„ ì„ íƒí•˜ì„¸ìš”.");
      if (!confirm(selected.length + "ê°œì˜ ê¸°ë¡ì„ ì‚­ì œí• ê¹Œìš”?")) return;

      const indexes = selected
        .map(li => Number(li.dataset.index))
        .filter(n => !Number.isNaN(n))
        .sort((a, b) => b - a);

      indexes.forEach(idx => { if (idx >= 0 && idx < logs.length) logs.splice(idx, 1); });
      saveLogs();
      renderLogs();
    }
    function editSelectedLog() {
      const selected = getSelectedLogItems();
      if (selected.length === 0) return alert("ìˆ˜ì •í•  ê¸°ë¡ì„ ì„ íƒí•˜ì„¸ìš”.");
      if (selected.length > 1) return alert("í•œ ë²ˆì— í•˜ë‚˜ì˜ ê¸°ë¡ë§Œ ìˆ˜ì •í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.");

      const idx = Number(selected[0].dataset.index);
      if (Number.isNaN(idx) || idx < 0 || idx >= logs.length) return alert("ë¡œê·¸ ì¸ë±ìŠ¤ ì˜¤ë¥˜ì…ë‹ˆë‹¤.");

      const old = logs[idx];
      const newLabel = prompt("ìƒˆ ë‚´ìš©(ë¼ë²¨)ì„ ì…ë ¥í•˜ì„¸ìš”:", old.label);
      if (!newLabel || newLabel.trim() === "") return;

      logs[idx].label = newLabel.trim();
      saveLogs();
      renderLogs();
    }
    function deleteAllLogs() {
      if (logs.length === 0) return alert("ì‚­ì œí•  ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.");
      if (!confirm("ëª¨ë“  ê¸°ë¡ì„ ì‚­ì œí• ê¹Œìš”? (ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤)")) return;
      logs = [];
      saveLogs();
      renderLogs();
    }

    function fallbackCopyText(text, count, label) {
      const textarea = document.createElement("textarea");
      textarea.value = text;
      textarea.style.position = "fixed";
      textarea.style.top = "-9999px";
      document.body.appendChild(textarea);
      textarea.select();
      try {
        document.execCommand("copy");
        alert(label + " ê¸°ë¡ì´ í´ë¦½ë³´ë“œì— ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤. (" + count + "ê°œ)");
      } catch (e) {
        alert("ë³µì‚¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ì§ì ‘ ì„ íƒí•´ì„œ ë³µì‚¬í•´ ì£¼ì„¸ìš”.");
      }
      document.body.removeChild(textarea);
    }
    function copyTextWithClipboard(text, count, label) {
      if (navigator.clipboard && navigator.clipboard.writeText) {
        navigator.clipboard.writeText(text)
          .then(() => alert(label + " ê¸°ë¡ì´ í´ë¦½ë³´ë“œì— ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤. (" + count + "ê°œ)"))
          .catch(() => fallbackCopyText(text, count, label));
      } else {
        fallbackCopyText(text, count, label);
      }
    }
    function copyAllLogs() {
      if (logs.length === 0) return alert("ë³µì‚¬í•  ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.");
      const lines = logs.map(log => `${log.time} - [${log.coord}] ${log.label}`);
      copyTextWithClipboard(lines.join("\n"), lines.length, "ì „ì²´");
    }
    function copySelectedLogs() {
      const selected = getSelectedLogItems();
      if (selected.length === 0) return alert("ë³µì‚¬í•  ê¸°ë¡ì„ ì„ íƒí•˜ì„¸ìš”.");
      const indexes = selected.map(li => Number(li.dataset.index)).filter(n => !Number.isNaN(n)).sort((a,b)=>a-b);
      const lines = indexes.map(idx => `${logs[idx].time} - [${logs[idx].coord}] ${logs[idx].label}`);
      copyTextWithClipboard(lines.join("\n"), lines.length, "ì„ íƒí•œ");
    }

    function updateBreadcrumb() {
      const bc = document.getElementById("breadcrumb");
      if (!bc) return;
      if (currentParentId === "root") return bc.textContent = "ìœ„ì¹˜: ROOT";

      const pathNodes = [];
      function dfs(node, targetId, path) {
        path.push(node);
        if (node.id === targetId) return true;
        const children = node.children || [];
        for (let i = 0; i < children.length; i++) {
          if (dfs(children[i], targetId, path)) return true;
        }
        path.pop();
        return false;
      }
      dfs(tree, currentParentId, pathNodes);
      bc.textContent = "ìœ„ì¹˜: " + pathNodes.map(n => n.label).join(" > ");
    }

    function renderButtons() {
      const container = document.getElementById("buttonContainer");
      if (!container) return;
      container.innerHTML = "";

      const parentNode = getCurrentParentNode();
      const children = parentNode.children || [];

      let parentDepth = getDepthById(tree, parentNode.id, 0);
      if (parentDepth < 0) parentDepth = 0;
      const colLetters = columnIndexToLetters(parentDepth + 1);

      if (children.length === 0) {
        const div = document.createElement("div");
        div.className = "empty-text";
        div.textContent = "ì´ ìœ„ì¹˜ì—ëŠ” ë²„íŠ¼ì´ ì—†ìŠµë‹ˆë‹¤. ì•„ë˜ì—ì„œ ìƒˆ ë²„íŠ¼ì„ ì¶”ê°€í•˜ì„¸ìš”.";
        container.appendChild(div);
        return;
      }

      children.forEach((child, index) => {
        const coord = colLetters + (index + 1);

        const row = document.createElement("div");
        row.className = "btn-row";

        const mainBtn = document.createElement("button");
        mainBtn.className = "btn-main";
        mainBtn.textContent = "[" + coord + "] " + child.label;

        mainBtn.addEventListener("click", () => {
          if (child.children && child.children.length > 0) {
            currentParentId = child.id;
            render();
          } else {
            appendLog(child.label, coord);
          }
        });

        const controls = document.createElement("div");
        controls.className = "btn-controls";

        const upBtn = document.createElement("button");
        upBtn.textContent = "â†‘";
        upBtn.addEventListener("click", () => moveSibling(parentNode, index, -1));

        const downBtn = document.createElement("button");
        downBtn.textContent = "â†“";
        downBtn.addEventListener("click", () => moveSibling(parentNode, index, 1));

        const addChildBtn = document.createElement("button");
        addChildBtn.textContent = "+í•˜ìœ„";
        addChildBtn.addEventListener("click", () => {
          const name = prompt("í•˜ìœ„ ë²„íŠ¼ ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”:");
          if (!name || name.trim() === "") return;
          if (!child.children) child.children = [];
          child.children.push({ id: genId(), label: name.trim(), children: [] });
          saveTree();
          render();
        });

        const renameBtn = document.createElement("button");
        renameBtn.textContent = "ì´ë¦„ë³€ê²½";
        renameBtn.addEventListener("click", () => {
          const newName = prompt("ìƒˆ ë²„íŠ¼ ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”:", child.label);
          if (!newName || newName.trim() === "") return;
          child.label = newName.trim();
          saveTree();
          render();
        });

        const delBtn = document.createElement("button");
        delBtn.textContent = "ì‚­ì œ";
        delBtn.addEventListener("click", () => {
          if (!confirm("'" + child.label + "' ë²„íŠ¼ì„ ì‚­ì œí• ê¹Œìš”? (í•˜ìœ„ ë²„íŠ¼ë„ í•¨ê»˜ ì‚­ì œë©ë‹ˆë‹¤)")) return;
          parentNode.children.splice(index, 1);
          saveTree();
          render();
        });

        controls.appendChild(upBtn);
        controls.appendChild(downBtn);
        controls.appendChild(addChildBtn);
        controls.appendChild(renameBtn);
        controls.appendChild(delBtn);

        row.appendChild(mainBtn);
        row.appendChild(controls);
        container.appendChild(row);
      });
    }

    function render() {
      if (currentParentId !== "root" && !findNodeById(tree, currentParentId)) currentParentId = "root";
      updateBreadcrumb();
      renderButtons();
      updateLogCount();
    }

    function openHelpModal() {
      const backdrop = document.getElementById("helpModalBackdrop");
      const editor = document.getElementById("helpEditor");
      if (!backdrop || !editor) return;
      editor.value = helpText || "";
      backdrop.style.display = "flex";
      setTimeout(() => editor.focus(), 0);
    }
    function closeHelpModal() {
      const backdrop = document.getElementById("helpModalBackdrop");
      if (backdrop) backdrop.style.display = "none";
    }

    loadTreeLocal();
    loadLogsLocal();
    loadHelpLocal();
    loadTodoLocal();
    renderTodoTable();
    render();
    showBackupWarningIfNeeded();
    setAuthUI();
    setMindNegative(false);

    document.getElementById("btnUp").addEventListener("click", () => {
      if (currentParentId === "root") return;
      const parentId = findParentId(tree, currentParentId, null);
      currentParentId = parentId || "root";
      render();
    });
    document.getElementById("btnRoot").addEventListener("click", () => {
      currentParentId = "root";
      render();
    });

    document.getElementById("btnAddHere").addEventListener("click", () => {
      const parentNode = getCurrentParentNode();
      const name = prompt("ìƒˆ ë²„íŠ¼ ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”:");
      if (!name || name.trim() === "") return;
      if (!parentNode.children) parentNode.children = [];
      parentNode.children.push({ id: genId(), label: name.trim(), children: [] });
      saveTree();
      render();
    });

    document.getElementById("btnDeleteLog").addEventListener("click", deleteSelectedLogs);
    document.getElementById("btnEditLog").addEventListener("click", editSelectedLog);
    document.getElementById("btnCopyAllLog").addEventListener("click", copyAllLogs);
    document.getElementById("btnCopySelectedLog").addEventListener("click", copySelectedLogs);
    document.getElementById("btnDeleteAllLog").addEventListener("click", deleteAllLogs);

    document.getElementById("btnEditHelp").addEventListener("click", openHelpModal);
    document.getElementById("btnHelpCancel").addEventListener("click", closeHelpModal);
    document.getElementById("btnHelpSave").addEventListener("click", () => {
      const editor = document.getElementById("helpEditor");
      const newText = (editor?.value || "").trim();
      if (!newText) return alert("ì•ˆë‚´ë¬¸ì€ ë¹„ì›Œë‘˜ ìˆ˜ ì—†ì–´ìš”.");
      helpText = newText;
      saveHelp();
      closeHelpModal();
    });
    document.getElementById("helpModalBackdrop").addEventListener("click", (e) => {
      if (e.target.id === "helpModalBackdrop") closeHelpModal();
    });

    document.getElementById("btnLogin").addEventListener("click", async () => {
      try { await auth.signInWithPopup(provider); }
      catch (e) {
        console.error(e);
        alert("ë¡œê·¸ì¸ ì‹¤íŒ¨: íŒì—… ì°¨ë‹¨ ë˜ëŠ” Firebase ë„ë©”ì¸ ì„¤ì • ë¬¸ì œì¼ ìˆ˜ ìˆì–´ìš”.\n\nF12 ì½˜ì†”ì˜ ì—ëŸ¬ì½”ë“œ(auth/...)ë¥¼ í™•ì¸í•´ ì£¼ì„¸ìš”.");
      }
    });
    document.getElementById("btnLogout").addEventListener("click", async () => {
      try { await auth.signOut(); } catch (e) { console.error(e); }
    });

    auth.onAuthStateChanged(async (user) => {
      currentUser = user || null;
      setAuthUI();

      if (!currentUser) {
        if (unsubscribeDoc) unsubscribeDoc();
        unsubscribeDoc = null;
        return;
      }

      try {
        await cloudFirstInit(currentUser.uid);
        startRealtimeListener(currentUser.uid);
        scheduleCloudSave();
      } catch (e) {
        console.error(e);
        alert("í´ë¼ìš°ë“œ ë™ê¸°í™” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. (F12 ì½˜ì†” í™•ì¸)");
      }
    });

    document.getElementById("btnMindRecord").addEventListener("click", recordMindScore);

    document.getElementById("mindScoreInput").addEventListener("input", () => {
      sanitizeMindInput();
      const input = document.getElementById("mindScoreInput");
      if (!input) return;
      const v = (input.value || "").trim();
      if (!v) return;
      const n = Number(v);
      if (Number.isFinite(n) && n > 100) {
        alert("ì ìˆ˜ëŠ” 0~100 ì‚¬ì´ë§Œ ì…ë ¥í•  ìˆ˜ ìˆì–´ìš”.");
        input.value = "100";
        input.focus();
      }
    });

    document.getElementById("mindScoreInput").addEventListener("blur", () => {
      const input = document.getElementById("mindScoreInput");
      if (!input) return;
      sanitizeMindInput();
      const v = (input.value || "").trim();
      if (!v) return;
      const n = Number(v);
      if (!Number.isFinite(n) || n < 0 || n > 100) {
        alert("ì ìˆ˜ëŠ” 0~100 ì‚¬ì´ë§Œ ì…ë ¥í•  ìˆ˜ ìˆì–´ìš”.");
        input.value = "";
      }
    });

    document.getElementById("mindScoreInput").addEventListener("keydown", (e) => {
      if (e.key === "Enter") {
        e.preventDefault();
        recordMindScore();
      }
    });

    document.getElementById("btnMinus").addEventListener("click", () => {
      toggleMindNegative();
      const { ok } = parseAndValidateMindScore({ showAlert: false });
      if (!ok) {
        const input = document.getElementById("mindScoreInput");
        if (input) input.value = "";
      }
    });
  </script>
</body>
</html>
